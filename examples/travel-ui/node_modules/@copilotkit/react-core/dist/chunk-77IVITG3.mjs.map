{"version":3,"sources":["../src/hooks/use-coagent-state-render-registry.ts"],"sourcesContent":["import { useEffect } from \"react\";\nimport {\n  areStatesEquals,\n  ClaimAction,\n  getEffectiveRunId,\n  isPlaceholderMessageId,\n  isPlaceholderMessageName,\n  readCachedMessageEntry,\n  resolveClaim,\n  selectSnapshot,\n  type Claim,\n  type ClaimsByMessageId,\n  type SnapshotCaches,\n  type StateRenderContext,\n} from \"./use-coagent-state-render-bridge.helpers\";\n\nexport interface StateRenderRegistryInput {\n  agentId: string;\n  stateRenderId?: string;\n  message: { id: string; runId?: string; name?: string };\n  messageIndex?: number;\n  stateSnapshot?: any;\n  agentState?: any;\n  agentMessages?: Array<{ id: string; role?: string }>;\n  claimsRef: React.MutableRefObject<Record<string, Claim>>;\n}\n\nexport interface StateRenderRegistryResult {\n  canRender: boolean;\n}\n\nconst LAST_SNAPSHOTS_BY_RENDER_AND_RUN = \"__lastSnapshotsByStateRenderIdAndRun\";\nconst LAST_SNAPSHOTS_BY_MESSAGE = \"__lastSnapshotsByMessageId\";\n\ntype SnapshotByMessageEntry = { snapshot: any; runId?: string } | any;\ntype ClaimsStore = Record<string, Claim> & {\n  [LAST_SNAPSHOTS_BY_RENDER_AND_RUN]?: Record<string, any>;\n  [LAST_SNAPSHOTS_BY_MESSAGE]?: Record<string, SnapshotByMessageEntry>;\n};\n\nfunction getClaimsStore(\n  claimsRef: React.MutableRefObject<Record<string, Claim>>,\n): ClaimsStore {\n  return claimsRef.current as ClaimsStore;\n}\n\nfunction getSnapshotCaches(claimsRef: React.MutableRefObject<Record<string, Claim>>): SnapshotCaches {\n  const store = getClaimsStore(claimsRef);\n  return {\n    byStateRenderAndRun: store[LAST_SNAPSHOTS_BY_RENDER_AND_RUN] ?? {},\n    byMessageId: store[LAST_SNAPSHOTS_BY_MESSAGE] ?? {},\n  };\n}\n\nexport function useStateRenderRegistry({\n  agentId,\n  stateRenderId,\n  message,\n  messageIndex,\n  stateSnapshot,\n  agentState,\n  agentMessages,\n  claimsRef,\n}: StateRenderRegistryInput): StateRenderRegistryResult {\n  const store = getClaimsStore(claimsRef);\n  const runId = message.runId;\n  const cachedMessageEntry = store[LAST_SNAPSHOTS_BY_MESSAGE]?.[message.id];\n  const { runId: cachedMessageRunId } = readCachedMessageEntry(cachedMessageEntry);\n  const existingClaimRunId = claimsRef.current[message.id]?.runId;\n  const effectiveRunId = getEffectiveRunId({\n    existingClaimRunId,\n    cachedMessageRunId,\n    runId,\n  });\n\n  useEffect(() => {\n    return () => {\n      const existingClaim = claimsRef.current[message.id];\n      if (\n        existingClaim?.stateSnapshot &&\n        Object.keys(existingClaim.stateSnapshot).length > 0\n      ) {\n        const snapshotCache = {\n          ...(store[LAST_SNAPSHOTS_BY_RENDER_AND_RUN] ?? {}),\n        };\n        const cacheKey = `${existingClaim.stateRenderId}::${existingClaim.runId ?? \"pending\"}`;\n        snapshotCache[cacheKey] = existingClaim.stateSnapshot;\n        snapshotCache[`${existingClaim.stateRenderId}::latest`] = existingClaim.stateSnapshot;\n        store[LAST_SNAPSHOTS_BY_RENDER_AND_RUN] = snapshotCache;\n\n        const messageCache = {\n          ...(store[LAST_SNAPSHOTS_BY_MESSAGE] ?? {}),\n        };\n        messageCache[message.id] = {\n          snapshot: existingClaim.stateSnapshot,\n          runId: existingClaim.runId ?? effectiveRunId,\n        };\n        store[LAST_SNAPSHOTS_BY_MESSAGE] = messageCache;\n      }\n      delete claimsRef.current[message.id];\n    };\n  }, [claimsRef, effectiveRunId, message.id]);\n\n  if (!stateRenderId) {\n    return { canRender: false };\n  }\n\n  const caches = getSnapshotCaches(claimsRef);\n  const existingClaim = claimsRef.current[message.id] as Claim | undefined;\n\n  const { snapshot, hasSnapshotKeys, allowEmptySnapshot, snapshotForClaim } = selectSnapshot({\n    messageId: message.id,\n    messageName: message.name,\n    allowLiveState:\n      isPlaceholderMessageName(message.name) || isPlaceholderMessageId(message.id),\n    skipLatestCache:\n      isPlaceholderMessageName(message.name) || isPlaceholderMessageId(message.id),\n    stateRenderId,\n    effectiveRunId,\n    stateSnapshotProp: stateSnapshot,\n    agentState,\n    agentMessages,\n    existingClaim,\n    caches,\n  });\n\n  const resolution = resolveClaim({\n    claims: claimsRef.current as ClaimsByMessageId,\n    context: {\n      agentId,\n      messageId: message.id,\n      stateRenderId,\n      runId: effectiveRunId,\n      messageIndex,\n    } satisfies StateRenderContext,\n    stateSnapshot: snapshotForClaim,\n  });\n\n  if (resolution.action === ClaimAction.Block) {\n    return { canRender: false };\n  }\n\n  if (resolution.updateRunId && claimsRef.current[message.id]) {\n    claimsRef.current[message.id].runId = resolution.updateRunId;\n  }\n\n  if (resolution.nextClaim) {\n    claimsRef.current[message.id] = resolution.nextClaim;\n  }\n\n  if (resolution.lockOthers) {\n    Object.entries(claimsRef.current).forEach(([id, claim]) => {\n      if (id !== message.id && claim.stateRenderId === stateRenderId) {\n        claim.locked = true;\n      }\n    });\n  }\n\n  if (existingClaim && !existingClaim.locked && agentMessages?.length) {\n    const indexInAgentMessages = agentMessages.findIndex((msg: any) => msg.id === message.id);\n    if (indexInAgentMessages >= 0 && indexInAgentMessages < agentMessages.length - 1) {\n      existingClaim.locked = true;\n    }\n  }\n\n  const existingSnapshot = claimsRef.current[message.id].stateSnapshot;\n  const snapshotChanged =\n    stateSnapshot &&\n    existingSnapshot !== undefined &&\n    !areStatesEquals(existingSnapshot, snapshot);\n\n  if (\n    snapshot &&\n    (stateSnapshot || hasSnapshotKeys || allowEmptySnapshot) &&\n    (!claimsRef.current[message.id].locked || snapshotChanged)\n  ) {\n    if (!claimsRef.current[message.id].locked || snapshotChanged) {\n      claimsRef.current[message.id].stateSnapshot = snapshot;\n      const snapshotCache = {\n        ...(store[LAST_SNAPSHOTS_BY_RENDER_AND_RUN] ?? {}),\n      };\n      const cacheKey = `${stateRenderId}::${effectiveRunId}`;\n      snapshotCache[cacheKey] = snapshot;\n      snapshotCache[`${stateRenderId}::latest`] = snapshot;\n      store[LAST_SNAPSHOTS_BY_RENDER_AND_RUN] = snapshotCache;\n      const messageCache = {\n        ...(store[LAST_SNAPSHOTS_BY_MESSAGE] ?? {}),\n      };\n      messageCache[message.id] = { snapshot, runId: effectiveRunId };\n      store[LAST_SNAPSHOTS_BY_MESSAGE] = messageCache;\n      if (stateSnapshot) {\n        claimsRef.current[message.id].locked = true;\n      }\n    }\n  } else if (snapshotForClaim) {\n    const existingSnapshot = claimsRef.current[message.id].stateSnapshot;\n    if (!existingSnapshot) {\n      claimsRef.current[message.id].stateSnapshot = snapshotForClaim;\n      const snapshotCache = {\n        ...(store[LAST_SNAPSHOTS_BY_RENDER_AND_RUN] ?? {}),\n      };\n      const cacheKey = `${stateRenderId}::${effectiveRunId}`;\n      snapshotCache[cacheKey] = snapshotForClaim;\n      snapshotCache[`${stateRenderId}::latest`] = snapshotForClaim;\n      store[LAST_SNAPSHOTS_BY_RENDER_AND_RUN] = snapshotCache;\n      const messageCache = {\n        ...(store[LAST_SNAPSHOTS_BY_MESSAGE] ?? {}),\n      };\n      messageCache[message.id] = { snapshot: snapshotForClaim, runId: effectiveRunId };\n      store[LAST_SNAPSHOTS_BY_MESSAGE] = messageCache;\n    }\n  }\n\n  return { canRender: true };\n}\n"],"mappings":"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","names":["_a","_b","_c","_d","existingClaim","existingSnapshot"]}