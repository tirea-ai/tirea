{"version":3,"sources":["../src/components/copilot-provider/copilot-messages.tsx"],"sourcesContent":["/**\n * An internal context to separate the messages state (which is constantly changing) from the rest of CopilotKit context\n */\n\nimport {\n  ReactNode,\n  useEffect,\n  useState,\n  useRef,\n  useCallback,\n  useMemo,\n  createContext,\n  useContext,\n} from \"react\";\nimport { CopilotMessagesContext } from \"../../context/copilot-messages-context\";\nimport {\n  loadMessagesFromJsonRepresentation,\n  Message,\n  GraphQLError,\n} from \"@copilotkit/runtime-client-gql\";\nimport { useCopilotContext } from \"../../context/copilot-context\";\nimport { useToast } from \"../toast/toast-provider\";\nimport { shouldShowDevConsole } from \"../../utils/dev-console\";\nimport {\n  ErrorVisibility,\n  CopilotKitApiDiscoveryError,\n  CopilotKitRemoteEndpointDiscoveryError,\n  CopilotKitAgentDiscoveryError,\n  CopilotKitError,\n  CopilotKitErrorCode,\n} from \"@copilotkit/shared\";\nimport { Suggestion } from \"@copilotkitnext/core\";\n\n// Helper to determine if error should show as banner based on visibility and legacy patterns\nfunction shouldShowAsBanner(gqlError: GraphQLError): boolean {\n  const extensions = gqlError.extensions;\n  if (!extensions) return false;\n\n  // Priority 1: Check error code for discovery errors (these should always be banners)\n  const code = extensions.code as CopilotKitErrorCode;\n  if (\n    code === CopilotKitErrorCode.AGENT_NOT_FOUND ||\n    code === CopilotKitErrorCode.API_NOT_FOUND ||\n    code === CopilotKitErrorCode.REMOTE_ENDPOINT_NOT_FOUND ||\n    code === CopilotKitErrorCode.CONFIGURATION_ERROR ||\n    code === CopilotKitErrorCode.MISSING_PUBLIC_API_KEY_ERROR ||\n    code === CopilotKitErrorCode.UPGRADE_REQUIRED_ERROR\n  ) {\n    return true;\n  }\n\n  // Priority 2: Check banner visibility\n  if (extensions.visibility === ErrorVisibility.BANNER) {\n    return true;\n  }\n\n  // Priority 3: Check for critical errors that should be banners regardless of formal classification\n  const errorMessage = gqlError.message.toLowerCase();\n  if (\n    errorMessage.includes(\"api key\") ||\n    errorMessage.includes(\"401\") ||\n    errorMessage.includes(\"unauthorized\") ||\n    errorMessage.includes(\"authentication\") ||\n    errorMessage.includes(\"incorrect api key\")\n  ) {\n    return true;\n  }\n\n  // Priority 4: Legacy stack trace detection for discovery errors\n  const originalError = extensions.originalError as any;\n  if (originalError?.stack) {\n    return (\n      originalError.stack.includes(\"CopilotApiDiscoveryError\") ||\n      originalError.stack.includes(\"CopilotKitRemoteEndpointDiscoveryError\") ||\n      originalError.stack.includes(\"CopilotKitAgentDiscoveryError\")\n    );\n  }\n\n  return false;\n}\n\n/**\n * MessagesTap is used to mitigate performance issues when we only need\n * a snapshot of the messages, not a continuously updating stream of messages.\n */\n\nexport type MessagesTap = {\n  getMessagesFromTap: () => Message[];\n  updateTapMessages: (messages: Message[]) => void;\n};\n\nconst MessagesTapContext = createContext<MessagesTap | null>(null);\n\nexport function useMessagesTap() {\n  const tap = useContext(MessagesTapContext);\n  if (!tap) throw new Error(\"useMessagesTap must be used inside <MessagesTapProvider>\");\n  return tap;\n}\n\nexport function MessagesTapProvider({ children }: { children: React.ReactNode }) {\n  const messagesRef = useRef<Message[]>([]);\n\n  const tapRef = useRef<MessagesTap>({\n    getMessagesFromTap: () => messagesRef.current,\n    updateTapMessages: (messages: Message[]) => {\n      messagesRef.current = messages;\n    },\n  });\n\n  return (\n    <MessagesTapContext.Provider value={tapRef.current}>{children}</MessagesTapContext.Provider>\n  );\n}\n\n/**\n * CopilotKit messages context.\n */\n\nexport function CopilotMessages({ children }: { children: ReactNode }) {\n  const [messages, setMessages] = useState<Message[]>([]);\n  const lastLoadedThreadId = useRef<string>(undefined!);\n  const lastLoadedAgentName = useRef<string>(undefined!);\n  const lastLoadedMessages = useRef<string>(undefined!);\n\n  const { updateTapMessages } = useMessagesTap();\n\n  const { threadId, agentSession, showDevConsole, onError, copilotApiConfig } = useCopilotContext();\n  const { setBannerError } = useToast();\n\n  // Helper function to trace UI errors (similar to useCopilotRuntimeClient)\n  const traceUIError = useCallback(\n    async (error: CopilotKitError, originalError?: any) => {\n      // Just check if onError and publicApiKey are defined\n      if (!onError || !copilotApiConfig.publicApiKey) return;\n\n      try {\n        const traceEvent = {\n          type: \"error\" as const,\n          timestamp: Date.now(),\n          context: {\n            source: \"ui\" as const,\n            request: {\n              operation: \"loadAgentState\",\n              url: copilotApiConfig.chatApiEndpoint,\n              startTime: Date.now(),\n            },\n            technical: {\n              environment: \"browser\",\n              userAgent: typeof navigator !== \"undefined\" ? navigator.userAgent : undefined,\n              stackTrace: originalError instanceof Error ? originalError.stack : undefined,\n            },\n          },\n          error,\n        };\n        await onError(traceEvent);\n      } catch (traceError) {\n        console.error(\"Error in CopilotMessages onError handler:\", traceError);\n      }\n    },\n    [onError, copilotApiConfig.publicApiKey, copilotApiConfig.chatApiEndpoint],\n  );\n\n  const createStructuredError = (gqlError: GraphQLError): CopilotKitError | null => {\n    const extensions = gqlError.extensions;\n    const originalError = extensions?.originalError as any;\n\n    // Priority: Check stack trace for discovery errors first\n    if (originalError?.stack) {\n      if (originalError.stack.includes(\"CopilotApiDiscoveryError\")) {\n        return new CopilotKitApiDiscoveryError({ message: originalError.message });\n      }\n      if (originalError.stack.includes(\"CopilotKitRemoteEndpointDiscoveryError\")) {\n        return new CopilotKitRemoteEndpointDiscoveryError({ message: originalError.message });\n      }\n      if (originalError.stack.includes(\"CopilotKitAgentDiscoveryError\")) {\n        return new CopilotKitAgentDiscoveryError({\n          agentName: \"\",\n          availableAgents: [],\n        });\n      }\n    }\n\n    // Fallback: Use the formal error code if available\n    const message = originalError?.message || gqlError.message;\n    const code = extensions?.code as CopilotKitErrorCode;\n\n    if (code) {\n      return new CopilotKitError({ message, code });\n    }\n\n    return null;\n  };\n\n  const handleGraphQLErrors = useCallback(\n    (error: any) => {\n      if (error.graphQLErrors?.length) {\n        const graphQLErrors = error.graphQLErrors as GraphQLError[];\n\n        // Route all errors to banners for consistent UI\n        const routeError = (gqlError: GraphQLError) => {\n          const extensions = gqlError.extensions;\n          const visibility = extensions?.visibility as ErrorVisibility;\n          const isDev = shouldShowDevConsole(showDevConsole);\n\n          if (!isDev) {\n            console.error(\"CopilotKit Error (hidden in production):\", gqlError.message);\n            return;\n          }\n\n          // Silent errors - just log\n          if (visibility === ErrorVisibility.SILENT) {\n            console.error(\"CopilotKit Silent Error:\", gqlError.message);\n            return;\n          }\n\n          // All other errors (including DEV_ONLY) show as banners for consistency\n          const ckError = createStructuredError(gqlError);\n          if (ckError) {\n            setBannerError(ckError);\n            // Trace the structured error\n            traceUIError(ckError, gqlError);\n          } else {\n            // Fallback: create a generic error for unstructured GraphQL errors\n            const fallbackError = new CopilotKitError({\n              message: gqlError.message,\n              code: CopilotKitErrorCode.UNKNOWN,\n            });\n            setBannerError(fallbackError);\n            // Trace the fallback error\n            traceUIError(fallbackError, gqlError);\n          }\n        };\n\n        // Process all errors as banners\n        graphQLErrors.forEach(routeError);\n      } else {\n        const isDev = shouldShowDevConsole(showDevConsole);\n        if (!isDev) {\n          console.error(\"CopilotKit Error (hidden in production):\", error);\n        } else {\n          // Route non-GraphQL errors to banner as well\n          const fallbackError = new CopilotKitError({\n            message: error?.message || String(error),\n            code: CopilotKitErrorCode.UNKNOWN,\n          });\n          setBannerError(fallbackError);\n          // Trace the non-GraphQL error\n          traceUIError(fallbackError, error);\n        }\n      }\n    },\n    [setBannerError, showDevConsole, traceUIError],\n  );\n\n  useEffect(() => {\n    updateTapMessages(messages);\n  }, [messages, updateTapMessages]);\n\n  const memoizedChildren = useMemo(() => children, [children]);\n  const [suggestions, setSuggestions] = useState<Suggestion[]>([]);\n\n  return (\n    <CopilotMessagesContext.Provider\n      value={{\n        messages,\n        setMessages,\n        suggestions,\n        setSuggestions,\n      }}\n    >\n      {memoizedChildren}\n    </CopilotMessagesContext.Provider>\n  );\n}\n"],"mappings":"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","names":[]}