{"version":3,"sources":["../src/hooks/use-langgraph-interrupt-render.ts"],"sourcesContent":["import { useCopilotContext } from \"../context\";\nimport React, { useCallback, useEffect, useMemo } from \"react\";\nimport type { AbstractAgent, AgentSubscriber } from \"@ag-ui/client\";\nimport { MetaEventName } from \"@copilotkit/runtime-client-gql\";\nimport { dataToUUID, parseJson } from \"@copilotkit/shared\";\nimport { useAgentNodeName } from \"./use-agent-nodename\";\nimport { useCopilotChatConfiguration } from \"@copilotkitnext/react\";\n\ntype InterruptProps = {\n  event: any;\n  result: any;\n  render: (props: {\n    event: any;\n    result: any;\n    resolve: (response: string) => void;\n  }) => string | React.ReactElement;\n  resolve: (response: string) => void;\n};\n\nconst InterruptRenderer: React.FC<InterruptProps> = ({ event, result, render, resolve }) => {\n  return render({ event, result, resolve });\n};\n\nexport function useLangGraphInterruptRender(\n  agent: AbstractAgent,\n): string | React.ReactElement | null {\n  const {\n    interruptActions,\n    agentSession,\n    threadId,\n    interruptEventQueue,\n    addInterruptEvent,\n    resolveInterruptEvent,\n  } = useCopilotContext();\n  const existingConfig = useCopilotChatConfiguration();\n  const resolvedAgentId = existingConfig?.agentId ?? \"default\";\n  const nodeName = useAgentNodeName(resolvedAgentId);\n\n  useEffect(() => {\n    if (!agent) return;\n    let localInterrupt: any = null;\n    const subscriber: AgentSubscriber = {\n      onCustomEvent: ({ event }) => {\n        if (event.name === \"on_interrupt\") {\n          const eventData = {\n            name: MetaEventName.LangGraphInterruptEvent,\n            type: event.type,\n            value: parseJson(event.value, event.value),\n          };\n          const eventId = dataToUUID(eventData, \"interruptEvents\");\n          localInterrupt = {\n            eventId,\n            threadId,\n            event: eventData,\n          };\n        }\n      },\n      onRunStartedEvent: () => {\n        localInterrupt = null;\n      },\n      onRunFinalized: () => {\n        if (localInterrupt) {\n          addInterruptEvent(localInterrupt);\n          localInterrupt = null;\n        }\n      },\n    };\n\n    const { unsubscribe } = agent.subscribe(subscriber);\n    return () => {\n      unsubscribe();\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [agent, threadId]);\n\n  const handleResolve = useCallback(\n    (eventId: string, response?: string) => {\n      agent?.runAgent({\n        forwardedProps: {\n          command: {\n            resume: response,\n          },\n        },\n      });\n      resolveInterruptEvent(threadId, eventId, response ?? \"\");\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [agent, threadId],\n  );\n\n  return useMemo(() => {\n    // Get the queue for this thread and find the first unresponded event\n    const eventQueue = interruptEventQueue[threadId] || [];\n    const currentQueuedEvent = eventQueue.find((qe) => !qe.event.response);\n\n    if (!currentQueuedEvent || !agentSession) return null;\n\n    // Find the first matching action from all registered actions\n    const allActions = Object.values(interruptActions);\n    const matchingAction = allActions.find((action) => {\n      if (!action.enabled) return true; // No filter = match all\n      return action.enabled({\n        eventValue: currentQueuedEvent.event.value,\n        agentMetadata: {\n          ...agentSession,\n          nodeName,\n        },\n      });\n    });\n\n    if (!matchingAction) return null;\n\n    const { render, handler } = matchingAction;\n\n    const resolveInterrupt = (response: string) => {\n      handleResolve(currentQueuedEvent.eventId, response);\n    };\n\n    let result = null;\n    if (handler) {\n      result = handler({\n        event: currentQueuedEvent.event,\n        resolve: resolveInterrupt,\n      });\n    }\n\n    if (!render) return null;\n\n    return React.createElement(InterruptRenderer, {\n      event: currentQueuedEvent.event,\n      result,\n      render,\n      resolve: resolveInterrupt,\n    });\n  }, [interruptActions, interruptEventQueue, threadId, agentSession, handleResolve]);\n}\n"],"mappings":"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","names":[]}