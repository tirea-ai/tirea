{"version":3,"sources":["../src/components/CopilotListeners.tsx"],"sourcesContent":["import { useCallback, useEffect, useMemo, useRef } from \"react\";\nimport { useAgent, useCopilotChatConfiguration, useCopilotKit } from \"@copilotkitnext/react\";\nimport { CopilotKitError, parseJson } from \"@copilotkit/shared\";\nimport { useCopilotContext } from \"../context\";\nimport { AbstractAgent, AgentSubscriber, AGUIConnectNotImplementedError } from \"@ag-ui/client\";\nimport { useErrorToast } from \"./error-boundary/error-utils\";\nimport { CopilotKitCoreSubscriber } from \"@copilotkitnext/core\";\nimport { useToast } from \"./toast/toast-provider\";\nimport { CopilotKitLowLevelError } from \"@copilotkit/shared\";\n\nconst usePredictStateSubscription = (agent?: AbstractAgent) => {\n  const predictStateToolsRef = useRef<\n    {\n      tool: string;\n      state_key: string;\n      tool_argument: string;\n    }[]\n  >([]);\n\n  const getSubscriber = useCallback(\n    (agent: AbstractAgent): AgentSubscriber => ({\n      onCustomEvent: ({ event }) => {\n        if (event.name === \"PredictState\") {\n          predictStateToolsRef.current = event.value;\n        }\n      },\n      onToolCallArgsEvent: ({ partialToolCallArgs, toolCallName }) => {\n        predictStateToolsRef.current.forEach((t) => {\n          if (t?.tool !== toolCallName) return;\n\n          const emittedState =\n            typeof partialToolCallArgs === \"string\"\n              ? parseJson(partialToolCallArgs as unknown as string, partialToolCallArgs)\n              : partialToolCallArgs;\n\n          agent.setState({\n            [t.state_key]: emittedState[t.state_key],\n          });\n        });\n      },\n    }),\n    [],\n  );\n\n  useEffect(() => {\n    if (!agent) return;\n\n    const subscriber = getSubscriber(agent);\n    const { unsubscribe } = agent.subscribe(subscriber);\n    return () => {\n      unsubscribe();\n    };\n  }, [agent, getSubscriber]);\n};\n\nexport function CopilotListeners() {\n  const { copilotkit } = useCopilotKit();\n  const existingConfig = useCopilotChatConfiguration();\n  const resolvedAgentId = existingConfig?.agentId;\n  const { setBannerError } = useToast();\n\n  const { agent } = useAgent({ agentId: resolvedAgentId });\n\n  usePredictStateSubscription(agent);\n\n  useEffect(() => {\n    const subscriber: CopilotKitCoreSubscriber = {\n      onError: ({ error }) => {\n        // @ts-expect-error -- for now, choose a random CPK error type to display the error toast\n        setBannerError(new CopilotKitLowLevelError({ error, message: error.message }));\n      },\n    };\n    const subscription = copilotkit.subscribe(subscriber);\n\n    return () => {\n      subscription.unsubscribe();\n    };\n  }, [copilotkit?.subscribe]);\n\n  return null;\n}\n"],"mappings":";;;;;AAAA,SAAS,aAAa,WAAoB,cAAc;AACxD,SAAS,UAAU,6BAA6B,qBAAqB;AACrE,SAA0B,iBAAiB;AAM3C,SAAS,+BAA+B;AAExC,IAAM,8BAA8B,CAAC,UAA0B;AAC7D,QAAM,uBAAuB,OAM3B,CAAC,CAAC;AAEJ,QAAM,gBAAgB;AAAA,IACpB,CAACA,YAA2C;AAAA,MAC1C,eAAe,CAAC,EAAE,MAAM,MAAM;AAC5B,YAAI,MAAM,SAAS,gBAAgB;AACjC,+BAAqB,UAAU,MAAM;AAAA,QACvC;AAAA,MACF;AAAA,MACA,qBAAqB,CAAC,EAAE,qBAAqB,aAAa,MAAM;AAC9D,6BAAqB,QAAQ,QAAQ,CAAC,MAAM;AAC1C,eAAI,uBAAG,UAAS;AAAc;AAE9B,gBAAM,eACJ,OAAO,wBAAwB,WAC3B,UAAU,qBAA0C,mBAAmB,IACvE;AAEN,UAAAA,OAAM,SAAS;AAAA,YACb,CAAC,EAAE,SAAS,GAAG,aAAa,EAAE,SAAS;AAAA,UACzC,CAAC;AAAA,QACH,CAAC;AAAA,MACH;AAAA,IACF;AAAA,IACA,CAAC;AAAA,EACH;AAEA,YAAU,MAAM;AACd,QAAI,CAAC;AAAO;AAEZ,UAAM,aAAa,cAAc,KAAK;AACtC,UAAM,EAAE,YAAY,IAAI,MAAM,UAAU,UAAU;AAClD,WAAO,MAAM;AACX,kBAAY;AAAA,IACd;AAAA,EACF,GAAG,CAAC,OAAO,aAAa,CAAC;AAC3B;AAEO,SAAS,mBAAmB;AACjC,QAAM,EAAE,WAAW,IAAI,cAAc;AACrC,QAAM,iBAAiB,4BAA4B;AACnD,QAAM,kBAAkB,iDAAgB;AACxC,QAAM,EAAE,eAAe,IAAI,SAAS;AAEpC,QAAM,EAAE,MAAM,IAAI,SAAS,EAAE,SAAS,gBAAgB,CAAC;AAEvD,8BAA4B,KAAK;AAEjC,YAAU,MAAM;AACd,UAAM,aAAuC;AAAA,MAC3C,SAAS,CAAC,EAAE,MAAM,MAAM;AAEtB,uBAAe,IAAI,wBAAwB,EAAE,OAAO,SAAS,MAAM,QAAQ,CAAC,CAAC;AAAA,MAC/E;AAAA,IACF;AACA,UAAM,eAAe,WAAW,UAAU,UAAU;AAEpD,WAAO,MAAM;AACX,mBAAa,YAAY;AAAA,IAC3B;AAAA,EACF,GAAG,CAAC,yCAAY,SAAS,CAAC;AAE1B,SAAO;AACT;","names":["agent"]}