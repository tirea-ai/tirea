!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@ag-ui/client"),require("@copilotkitnext/shared")):"function"==typeof define&&define.amd?define(["exports","@ag-ui/client","@copilotkitnext/shared"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CopilotKitNextCore={},e.AgUIClient,e.CopilotKitNextShared)}(this,function(e,t,n){"use strict";class r extends t.HttpAgent{constructor(e){var t,n,r;const i=e.runtimeUrl?e.runtimeUrl.replace(/\/$/,""):void 0,s=null!==(t=e.transport)&&void 0!==t?t:"rest",o="single"===s?null!==(n=null!=i?i:e.runtimeUrl)&&void 0!==n?n:"":`${null!=i?i:e.runtimeUrl}/agent/${encodeURIComponent(null!==(r=e.agentId)&&void 0!==r?r:"")}/run`;if(!o)throw new Error("ProxiedCopilotRuntimeAgent requires a runtimeUrl when transport is set to 'single'.");super({...e,url:o}),this.runtimeUrl=null!=i?i:e.runtimeUrl,this.credentials=e.credentials,this.transport=s,"single"===this.transport&&(this.singleEndpointUrl=this.runtimeUrl)}abortRun(){if(!this.agentId||!this.threadId)return;if("undefined"==typeof fetch)return;if("single"===this.transport){if(!this.singleEndpointUrl)return;const e=new Headers({...this.headers,"Content-Type":"application/json"});return void fetch(this.singleEndpointUrl,{method:"POST",headers:e,body:JSON.stringify({method:"agent/stop",params:{agentId:this.agentId,threadId:this.threadId}}),...this.credentials?{credentials:this.credentials}:{}}).catch(e=>{console.error("ProxiedCopilotRuntimeAgent: stop request failed",e)})}if(!this.runtimeUrl)return;const e=`${this.runtimeUrl}/agent/${encodeURIComponent(this.agentId)}/stop/${encodeURIComponent(this.threadId)}`,t="undefined"!=typeof window&&window.location?window.location.origin:"http://localhost",n=new URL(this.runtimeUrl,t),r=new URL(e,n);fetch(r.toString(),{method:"POST",headers:{"Content-Type":"application/json",...this.headers},...this.credentials?{credentials:this.credentials}:{}}).catch(e=>{console.error("ProxiedCopilotRuntimeAgent: stop request failed",e)})}connect(e){if("single"===this.transport){if(!this.singleEndpointUrl)throw new Error("Single endpoint transport requires a runtimeUrl");const n=this.createSingleRouteRequestInit(e,"agent/connect",{agentId:this.agentId}),r=t.runHttpRequest(this.singleEndpointUrl,n);return t.transformHttpEventStream(r)}const n=t.runHttpRequest(`${this.runtimeUrl}/agent/${this.agentId}/connect`,this.requestInit(e));return t.transformHttpEventStream(n)}run(e){if("single"===this.transport){if(!this.singleEndpointUrl)throw new Error("Single endpoint transport requires a runtimeUrl");const n=this.createSingleRouteRequestInit(e,"agent/run",{agentId:this.agentId}),r=t.runHttpRequest(this.singleEndpointUrl,n);return t.transformHttpEventStream(r)}return super.run(e)}clone(){const e=super.clone();return e.runtimeUrl=this.runtimeUrl,e.credentials=this.credentials,e.transport=this.transport,e.singleEndpointUrl=this.singleEndpointUrl,e}createSingleRouteRequestInit(e,t,n){var r,i;if(!this.agentId)throw new Error("ProxiedCopilotRuntimeAgent requires agentId to make runtime requests");const s=super.requestInit(e),o=new Headers(null!==(r=s.headers)&&void 0!==r?r:{});let a;if(o.set("Content-Type","application/json"),o.set("Accept",null!==(i=o.get("Accept"))&&void 0!==i?i:"text/event-stream"),"string"==typeof s.body)try{a=JSON.parse(s.body)}catch(e){console.warn("ProxiedCopilotRuntimeAgent: failed to parse request body for single route transport",e),a=void 0}const u={method:t};return n&&Object.keys(n).length>0&&(u.params=n),void 0!==a&&(u.body=a),{...s,headers:o,body:JSON.stringify(u),...this.credentials?{credentials:this.credentials}:{}}}}class i{constructor(t){this.core=t,this._agents={},this.localAgents={},this.remoteAgents={},this._runtimeConnectionStatus=e.CopilotKitCoreRuntimeConnectionStatus.Disconnected,this._runtimeTransport="rest",this._audioFileTranscriptionEnabled=!1}get agents(){return this._agents}get runtimeUrl(){return this._runtimeUrl}get runtimeVersion(){return this._runtimeVersion}get runtimeConnectionStatus(){return this._runtimeConnectionStatus}get runtimeTransport(){return this._runtimeTransport}get audioFileTranscriptionEnabled(){return this._audioFileTranscriptionEnabled}initialize(e){this.localAgents=this.assignAgentIds(e),this.applyHeadersToAgents(this.localAgents),this._agents=this.localAgents}setRuntimeUrl(e){const t=e?e.replace(/\/$/,""):void 0;this._runtimeUrl!==t&&(this._runtimeUrl=t,this.updateRuntimeConnection())}setRuntimeTransport(e){this._runtimeTransport!==e&&(this._runtimeTransport=e,this.updateRuntimeConnection())}setAgents__unsafe_dev_only(e){Object.entries(e).forEach(([e,t])=>{t&&this.validateAndAssignAgentId(e,t)}),this.localAgents=e,this._agents={...this.localAgents,...this.remoteAgents},this.applyHeadersToAgents(this._agents),this.notifyAgentsChanged()}addAgent__unsafe_dev_only({id:e,agent:t}){this.validateAndAssignAgentId(e,t),this.localAgents[e]=t,this.applyHeadersToAgent(t),this._agents={...this.localAgents,...this.remoteAgents},this.notifyAgentsChanged()}removeAgent__unsafe_dev_only(e){delete this.localAgents[e],this._agents={...this.localAgents,...this.remoteAgents},this.notifyAgentsChanged()}getAgent(t){if(t in this._agents)return this._agents[t];(void 0===this.runtimeUrl||this.runtimeConnectionStatus!==e.CopilotKitCoreRuntimeConnectionStatus.Disconnected&&this.runtimeConnectionStatus!==e.CopilotKitCoreRuntimeConnectionStatus.Connecting)&&console.warn(`Agent ${t} not found`)}applyHeadersToAgent(e){e instanceof t.HttpAgent&&(e.headers={...this.core.headers})}applyHeadersToAgents(e){Object.values(e).forEach(e=>{this.applyHeadersToAgent(e)})}applyCredentialsToAgent(e){e instanceof r&&(e.credentials=this.core.credentials)}applyCredentialsToAgents(e){Object.values(e).forEach(e=>{this.applyCredentialsToAgent(e)})}async updateRuntimeConnection(){var t;if("undefined"!=typeof window){if(!this.runtimeUrl)return this._runtimeConnectionStatus=e.CopilotKitCoreRuntimeConnectionStatus.Disconnected,this._runtimeVersion=void 0,this._audioFileTranscriptionEnabled=!1,this.remoteAgents={},this._agents=this.localAgents,await this.notifyRuntimeStatusChanged(e.CopilotKitCoreRuntimeConnectionStatus.Disconnected),void await this.notifyAgentsChanged();this._runtimeConnectionStatus=e.CopilotKitCoreRuntimeConnectionStatus.Connecting,await this.notifyRuntimeStatusChanged(e.CopilotKitCoreRuntimeConnectionStatus.Connecting);try{const n=await this.fetchRuntimeInfo(),{version:i,...s}=n,o=this.core.credentials,a=Object.fromEntries(Object.entries(s.agents).map(([e,{description:t}])=>{const n=new r({runtimeUrl:this.runtimeUrl,agentId:e,description:t,transport:this._runtimeTransport,credentials:o});return this.applyHeadersToAgent(n),[e,n]}));this.remoteAgents=a,this._agents={...this.localAgents,...this.remoteAgents},this._runtimeConnectionStatus=e.CopilotKitCoreRuntimeConnectionStatus.Connected,this._runtimeVersion=i,this._audioFileTranscriptionEnabled=null!==(t=n.audioFileTranscriptionEnabled)&&void 0!==t&&t,await this.notifyRuntimeStatusChanged(e.CopilotKitCoreRuntimeConnectionStatus.Connected),await this.notifyAgentsChanged()}catch(t){this._runtimeConnectionStatus=e.CopilotKitCoreRuntimeConnectionStatus.Error,this._runtimeVersion=void 0,this._audioFileTranscriptionEnabled=!1,this.remoteAgents={},this._agents=this.localAgents,await this.notifyRuntimeStatusChanged(e.CopilotKitCoreRuntimeConnectionStatus.Error),await this.notifyAgentsChanged();const r=t instanceof Error?t.message:JSON.stringify(t);n.logger.warn(`Failed to load runtime info (${this.runtimeUrl}/info): ${r}`);const i=t instanceof Error?t:new Error(String(t));await this.core.emitError({error:i,code:e.CopilotKitCoreErrorCode.RUNTIME_INFO_FETCH_FAILED,context:{runtimeUrl:this.runtimeUrl}})}}}async fetchRuntimeInfo(){if(!this.runtimeUrl)throw new Error("Runtime URL is not set");const e=this.core.headers,t=this.core.credentials,n={...e};if("single"===this._runtimeTransport){n["Content-Type"]||(n["Content-Type"]="application/json");const e=await fetch(this.runtimeUrl,{method:"POST",headers:n,body:JSON.stringify({method:"info"}),...t?{credentials:t}:{}});if("ok"in e&&!e.ok)throw new Error(`Runtime info request failed with status ${e.status}`);return await e.json()}const r=await fetch(`${this.runtimeUrl}/info`,{headers:n,...t?{credentials:t}:{}});if("ok"in r&&!r.ok)throw new Error(`Runtime info request failed with status ${r.status}`);return await r.json()}assignAgentIds(e){return Object.entries(e).forEach(([e,t])=>{t&&this.validateAndAssignAgentId(e,t)}),e}validateAndAssignAgentId(e,t){if(t.agentId&&t.agentId!==e)throw new Error(`Agent registration mismatch: Agent with ID "${t.agentId}" cannot be registered under key "${e}". The agent ID must match the registration key or be undefined.`);t.agentId||(t.agentId=e)}async notifyRuntimeStatusChanged(e){await this.core.notifySubscribers(t=>{var n;return null===(n=t.onRuntimeConnectionStatusChanged)||void 0===n?void 0:n.call(t,{copilotkit:this.core,status:e})},"Error in CopilotKitCore subscriber (onRuntimeConnectionStatusChanged):")}async notifyAgentsChanged(){await this.core.notifySubscribers(e=>{var t;return null===(t=e.onAgentsChanged)||void 0===t?void 0:t.call(e,{copilotkit:this.core,agents:this._agents})},"Subscriber onAgentsChanged error:")}}class s{constructor(e){this.core=e,this._context={}}get context(){return this._context}addContext({description:e,value:t}){const r=n.randomUUID();return this._context[r]={description:e,value:t},this.notifySubscribers(),r}removeContext(e){delete this._context[e],this.notifySubscribers()}async notifySubscribers(){await this.core.notifySubscribers(e=>{var t;return null===(t=e.onContextChanged)||void 0===t?void 0:t.call(e,{copilotkit:this.core,context:this._context})},"Subscriber onContextChanged error:")}}class o{constructor(e){this.core=e,this._suggestionsConfig={},this._suggestions={},this._runningSuggestions={}}initialize(e){for(const t of e)this._suggestionsConfig[n.randomUUID()]=t}addSuggestionsConfig(e){const t=n.randomUUID();return this._suggestionsConfig[t]=e,this.notifySuggestionsConfigChanged(),t}removeSuggestionsConfig(e){delete this._suggestionsConfig[e],this.notifySuggestionsConfigChanged()}reloadSuggestions(e){var t,r;this.clearSuggestions(e);const i=this.core.getAgent(e);if(!i)return;const s=null!==(r=null===(t=i.messages)||void 0===t?void 0:t.length)&&void 0!==r?r:0;let o=!1;for(const t of Object.values(this._suggestionsConfig)){if(void 0!==t.consumerAgentId&&"*"!==t.consumerAgentId&&t.consumerAgentId!==e)continue;if(!this.shouldShowSuggestions(t,s))continue;const r=n.randomUUID();a(t)?(o||(o=!0,this.notifySuggestionsStartedLoading(e)),this.generateSuggestions(r,t,e)):u(t)&&this.addStaticSuggestions(r,t,e)}}clearSuggestions(e){const t=this._runningSuggestions[e];if(t){for(const e of t)e.abortRun();delete this._runningSuggestions[e]}this._suggestions[e]={},this.notifySuggestionsChanged(e,[])}getSuggestions(e){var t,n,r;return{suggestions:Object.values(null!==(t=this._suggestions[e])&&void 0!==t?t:{}).flat(),isLoading:(null!==(r=null===(n=this._runningSuggestions[e])||void 0===n?void 0:n.length)&&void 0!==r?r:0)>0}}async generateSuggestions(e,t,n){var r,i,s,o,a;let u;try{const c=this.core.getAgent(null!==(r=t.providerAgentId)&&void 0!==r?r:"default");if(!c)throw new Error(`Suggestions provider agent not found: ${t.providerAgentId}`);const l=this.core.getAgent(n);if(!l)throw new Error(`Suggestions consumer agent not found: ${n}`);const g=c.clone();u=g,u.threadId=e,u.messages=JSON.parse(JSON.stringify(l.messages)),u.state=JSON.parse(JSON.stringify(l.state)),this._suggestions[n]={...null!==(i=this._suggestions[n])&&void 0!==i?i:{},[e]:[]},this._runningSuggestions[n]=[...null!==(s=this._runningSuggestions[n])&&void 0!==s?s:[],u],u.addMessage({id:e,role:"user",content:["Suggest what the user could say next. Provide clear, highly relevant suggestions by calling the `copilotkitSuggest` tool.",`Provide at least ${null!==(o=t.minSuggestions)&&void 0!==o?o:1} and at most ${null!==(a=t.maxSuggestions)&&void 0!==a?a:3} suggestions.`,`The user has the following tools available: ${JSON.stringify(this.core.buildFrontendTools(n))}.`,` ${t.instructions}`].join("\n")}),await u.runAgent({context:Object.values(this.core.context),forwardedProps:{...this.core.properties,toolChoice:{type:"function",function:{name:"copilotkitSuggest"}}},tools:[d]},{onMessagesChanged:({messages:t})=>{this.extractSuggestions(t,e,n,!0)}})}catch(e){console.warn("Error generating suggestions:",e)}finally{this.finalizeSuggestions(e,n);const t=this._runningSuggestions[n];if(u&&t){const e=t.filter(e=>e!==u);this._runningSuggestions[n]=e,0===e.length&&(delete this._runningSuggestions[n],await this.notifySuggestionsFinishedLoading(n))}}}finalizeSuggestions(e,t){var n;const r=this._suggestions[t],i=null==r?void 0:r[e];if(r&&i&&i.length>0){const s=i.filter(e=>""!==e.title||""!==e.message).map(e=>({...e,isLoading:!1}));s.length>0?r[e]=s:delete r[e];const o=Object.values(null!==(n=this._suggestions[t])&&void 0!==n?n:{}).flat();this.notifySuggestionsChanged(t,o,"finalized")}}extractSuggestions(e,t,r,i){var s,o,a;const u=e.findIndex(e=>e.id===t);if(-1==u)return;const d=[],c=e.slice(u+1);for(const e of c)if("assistant"===e.role&&e.toolCalls)for(const t of e.toolCalls)if("copilotkitSuggest"===t.function.name){const e=Array.isArray(t.function.arguments)?t.function.arguments.join(""):t.function.arguments,r=n.partialJSONParse(e);if(r&&"object"==typeof r&&"suggestions"in r){const e=r.suggestions;if(Array.isArray(e))for(const t of e)t&&"object"==typeof t&&"title"in t&&d.push({title:null!==(s=t.title)&&void 0!==s?s:"",message:null!==(o=t.message)&&void 0!==o?o:"",isLoading:!1})}}i&&d.length>0&&(d[d.length-1].isLoading=!0);const l=this._suggestions[r];if(l){l[t]=d;const e=Object.values(null!==(a=this._suggestions[r])&&void 0!==a?a:{}).flat();this.notifySuggestionsChanged(r,e,"suggestions changed")}}async notifySuggestionsConfigChanged(){await this.core.notifySubscribers(e=>{var t;return null===(t=e.onSuggestionsConfigChanged)||void 0===t?void 0:t.call(e,{copilotkit:this.core,suggestionsConfig:this._suggestionsConfig})},"Subscriber onSuggestionsConfigChanged error:")}async notifySuggestionsChanged(e,t,n=""){await this.core.notifySubscribers(n=>{var r;return null===(r=n.onSuggestionsChanged)||void 0===r?void 0:r.call(n,{copilotkit:this.core,agentId:e,suggestions:t})},`Subscriber onSuggestionsChanged error: ${n}`)}async notifySuggestionsStartedLoading(e){await this.core.notifySubscribers(t=>{var n;return null===(n=t.onSuggestionsStartedLoading)||void 0===n?void 0:n.call(t,{copilotkit:this.core,agentId:e})},"Subscriber onSuggestionsStartedLoading error:")}async notifySuggestionsFinishedLoading(e){await this.core.notifySubscribers(t=>{var n;return null===(n=t.onSuggestionsFinishedLoading)||void 0===n?void 0:n.call(t,{copilotkit:this.core,agentId:e})},"Subscriber onSuggestionsFinishedLoading error:")}shouldShowSuggestions(e,t){const n=e.available;if(!n)return a(e)?t>0:0===t;switch(n){case"disabled":default:return!1;case"before-first-message":return 0===t;case"after-first-message":return t>0;case"always":return!0}}addStaticSuggestions(e,t,n){var r,i;const s=t.suggestions.map(e=>({...e,isLoading:!1}));this._suggestions[n]={...null!==(r=this._suggestions[n])&&void 0!==r?r:{},[e]:s};const o=Object.values(null!==(i=this._suggestions[n])&&void 0!==i?i:{}).flat();this.notifySuggestionsChanged(n,o,"static suggestions added")}}function a(e){return"instructions"in e}function u(e){return"suggestions"in e}const d={name:"copilotkitSuggest",description:"Suggest what the user could say next",parameters:{type:"object",properties:{suggestions:{type:"array",description:"List of suggestions shown to the user as buttons.",items:{type:"object",properties:{title:{type:"string",description:"The title of the suggestion. This is shown as a button and should be short."},message:{type:"string",description:"The message to send when the suggestion is clicked. This should be a clear, complete sentence and will be sent as an instruction to the AI."}},required:["title","message"]}}},required:["suggestions"]}},c=Symbol("Let zodToJsonSchema decide on which parser to use"),l={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},g=e=>{const t=(e=>"string"==typeof e?{...l,name:e}:{...l,...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}};function h(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function f(e,t,n,r,i){e[t]=n,h(e,t,r,i)}const p=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")};var m;function y(e){if("openAi"!==e.target)return{};const t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?p(t,e.currentPath):t.join("/")}}function v(e,t){return B(e.type._def,t)}!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(m||(m={}));function _(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((n,r)=>_(e,t,n))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return S(e,t)}}const S=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":f(n,"minimum",r.value,r.message,t);break;case"max":f(n,"maximum",r.value,r.message,t)}return n};let b;const A=/^[cC][^\s-]{8,}$/,C=/^[0-9a-z]+$/,I=/^[0-9A-HJKMNP-TV-Z]{26}$/,E=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,T=()=>(void 0===b&&(b=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),b),R=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,w=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Z=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,x=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,N=/^[a-zA-Z0-9_-]{21}$/,P=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function k(e,t){const n={type:"string"};if(e.checks)for(const r of e.checks)switch(r.kind){case"min":f(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t);break;case"max":f(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":j(n,"email",r.message,t);break;case"format:idn-email":j(n,"idn-email",r.message,t);break;case"pattern:zod":M(n,E,r.message,t)}break;case"url":j(n,"uri",r.message,t);break;case"uuid":j(n,"uuid",r.message,t);break;case"regex":M(n,r.regex,r.message,t);break;case"cuid":M(n,A,r.message,t);break;case"cuid2":M(n,C,r.message,t);break;case"startsWith":M(n,RegExp(`^${O(r.value,t)}`),r.message,t);break;case"endsWith":M(n,RegExp(`${O(r.value,t)}$`),r.message,t);break;case"datetime":j(n,"date-time",r.message,t);break;case"date":j(n,"date",r.message,t);break;case"time":j(n,"time",r.message,t);break;case"duration":j(n,"duration",r.message,t);break;case"length":f(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t),f(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"includes":M(n,RegExp(O(r.value,t)),r.message,t);break;case"ip":"v6"!==r.version&&j(n,"ipv4",r.message,t),"v4"!==r.version&&j(n,"ipv6",r.message,t);break;case"base64url":M(n,x,r.message,t);break;case"jwt":M(n,P,r.message,t);break;case"cidr":"v6"!==r.version&&M(n,R,r.message,t),"v4"!==r.version&&M(n,w,r.message,t);break;case"emoji":M(n,T(),r.message,t);break;case"ulid":M(n,I,r.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":j(n,"binary",r.message,t);break;case"contentEncoding:base64":f(n,"contentEncoding","base64",r.message,t);break;case"pattern:zod":M(n,Z,r.message,t)}break;case"nanoid":M(n,N,r.message,t)}return n}function O(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let n=0;n<e.length;n++)U.has(e[n])||(t+="\\"),t+=e[n];return t}(e):e}const U=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function j(e,t,n,r){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):f(e,"format",t,n,r)}function M(e,t,n,r){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:F(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):f(e,"pattern",F(t,r),n,r)}function F(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const n=e.flags.includes("i"),r=e.flags.includes("m"),i=e.flags.includes("s"),s=n?e.source.toLowerCase():e.source;let o="",a=!1,u=!1,d=!1;for(let e=0;e<s.length;e++)if(a)o+=s[e],a=!1;else{if(n)if(u){if(s[e].match(/[a-z]/)){d?(o+=s[e],o+=`${s[e-2]}-${s[e]}`.toUpperCase(),d=!1):"-"===s[e+1]&&s[e+2]?.match(/[a-z]/)?(o+=s[e],d=!0):o+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){o+=`[${s[e]}${s[e].toUpperCase()}]`;continue}if(r){if("^"===s[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===s[e]){o+="($|(?=[\r\n]))";continue}}i&&"."===s[e]?o+=u?`${s[e]}\r\n`:`[${s[e]}\r\n]`:(o+=s[e],"\\"===s[e]?a=!0:u&&"]"===s[e]?u=!1:u||"["!==s[e]||(u=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return o}function L(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===m.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,r)=>({...n,[r]:B(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??y(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};const n={type:"object",additionalProperties:B(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===m.ZodString&&e.keyType._def.checks?.length){const{type:r,...i}=k(e.keyType._def,t);return{...n,propertyNames:i}}if(e.keyType?._def.typeName===m.ZodEnum)return{...n,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===m.ZodBranded&&e.keyType._def.type._def.typeName===m.ZodString&&e.keyType._def.type._def.checks?.length){const{type:r,...i}=v(e.keyType._def,t);return{...n,propertyNames:i}}return n}const $={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};const D=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,n)=>B(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return n.length?{anyOf:n}:void 0};function z(e,t){const n="openAi"===t.target,r={type:"object",properties:{}},i=[],s=e.shape();for(const e in s){let o=s[e];if(void 0===o||void 0===o._def)continue;let a=H(o);a&&n&&("ZodOptional"===o._def.typeName&&(o=o._def.innerType),o.isNullable()||(o=o.nullable()),a=!1);const u=B(o._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==u&&(r.properties[e]=u,a||i.push(e))}i.length&&(r.required=i);const o=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return B(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==o&&(r.additionalProperties=o),r}function H(e){try{return e.isOptional()}catch{return!0}}const K=(e,t,n)=>{switch(t){case m.ZodString:return k(e,n);case m.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",h(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?f(n,"minimum",r.value,r.message,t):f(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),f(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?f(n,"maximum",r.value,r.message,t):f(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),f(n,"maximum",r.value,r.message,t));break;case"multipleOf":f(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case m.ZodObject:return z(e,n);case m.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?f(n,"minimum",r.value,r.message,t):f(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),f(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?f(n,"maximum",r.value,r.message,t):f(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),f(n,"maximum",r.value,r.message,t));break;case"multipleOf":f(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case m.ZodBoolean:return{type:"boolean"};case m.ZodDate:return _(e,n);case m.ZodUndefined:return function(e){return{not:y(e)}}(n);case m.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case m.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def&&e.type?._def?.typeName!==m.ZodAny&&(n.items=B(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&f(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&f(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(f(n,"minItems",e.exactLength.value,e.exactLength.message,t),f(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case m.ZodUnion:case m.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return D(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every(e=>e._def.typeName in $&&(!e._def.checks||!e._def.checks.length))){const e=n.reduce((e,t)=>{const n=$[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e},[]);return{type:e.length>1?e:e[0]}}if(n.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=n.reduce((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===n.length){const t=e.filter((e,t,n)=>n.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:n.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(n.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:n.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return D(e,t)}(e,n);case m.ZodIntersection:return function(e,t){const n=[B(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),B(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const i=[];return n.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;i.push(t)}else i.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t}),i.length?{allOf:i,...r}:void 0}(e,n);case m.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,n)=>B(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:B(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,n)=>B(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,n);case m.ZodRecord:return L(e,n);case m.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case m.ZodEnum:return function(e){return{type:"string",enum:Array.from(e.values)}}(e);case m.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),r=Array.from(new Set(n.map(e=>typeof e)));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case m.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:$[e.innerType._def.typeName],nullable:!0}:{type:[$[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=B(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=B(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case m.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return B(e.innerType._def,t);const n=B(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:y(t)},n]}:y(t)})(e,n);case m.ZodMap:return function(e,t){return"record"===t.mapStrategy?L(e,t):{type:"array",maxItems:125,items:{type:"array",items:[B(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||y(t),B(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||y(t)],minItems:2,maxItems:2}}}(e,n);case m.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:B(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&f(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&f(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case m.ZodLazy:return()=>e.getter()._def;case m.ZodPromise:return function(e,t){return B(e.type._def,t)}(e,n);case m.ZodNaN:case m.ZodNever:return function(e){return"openAi"===e.target?void 0:{not:y({...e,currentPath:[...e.currentPath,"not"]})}}(n);case m.ZodEffects:return function(e,t){return"input"===t.effectStrategy?B(e.schema._def,t):y(t)}(e,n);case m.ZodAny:return y(n);case m.ZodUnknown:return function(e){return y(e)}(n);case m.ZodDefault:return function(e,t){return{...B(e.innerType._def,t),default:e.defaultValue()}}(e,n);case m.ZodBranded:return v(e,n);case m.ZodReadonly:case m.ZodCatch:return((e,t)=>B(e.innerType._def,t))(e,n);case m.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return B(e.in._def,t);if("output"===t.pipeStrategy)return B(e.out._def,t);const n=B(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,B(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter(e=>void 0!==e)}})(e,n);case m.ZodFunction:case m.ZodVoid:case m.ZodSymbol:default:return}};function B(e,t,n=!1){const r=t.seen.get(e);if(t.override){const i=t.override?.(e,t,r,n);if(i!==c)return i}if(r&&!n){const e=q(r,t);if(void 0!==e)return e}const i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);const s=K(e,e.typeName,t),o="function"==typeof s?B(s(),t):s;if(o&&J(e,t,o),t.postProcess){const n=t.postProcess(o,e,t);return i.jsonSchema=o,n}return i.jsonSchema=o,o}const q=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:p(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,n)=>t.currentPath[n]===e)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),y(t)):"seen"===t.$refStrategy?y(t):void 0}},J=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n);class V{constructor(e){this.core=e,this._tools=[]}get tools(){return this._tools}initialize(e){this._tools=e}addTool(e){-1===this._tools.findIndex(t=>t.name===e.name&&t.agentId===e.agentId)?this._tools.push(e):n.logger.warn(`Tool already exists: '${e.name}' for agent '${e.agentId||"global"}', skipping.`)}removeTool(e,t){this._tools=this._tools.filter(n=>void 0!==t?!(n.name===e&&n.agentId===t):!(n.name===e&&!n.agentId))}getTool(e){const{toolName:t,agentId:n}=e;if(n){const e=this._tools.find(e=>e.name===t&&e.agentId===n);if(e)return e}return this._tools.find(e=>e.name===t&&!e.agentId)}setTools(e){this._tools=[...e]}async connectAgent({agent:n}){try{await n.detachActiveRun(),n.setMessages([]),n.setState({}),n instanceof t.HttpAgent&&(n.headers={...this.core.headers});const e=await n.connectAgent({forwardedProps:this.core.properties,tools:this.buildFrontendTools(n.agentId)},this.createAgentErrorSubscriber(n));return this.processAgentResult({runAgentResult:e,agent:n})}catch(t){const r=t instanceof Error?t:new Error(String(t)),i={};throw n.agentId&&(i.agentId=n.agentId),await this.core.emitError({error:r,code:e.CopilotKitCoreErrorCode.AGENT_CONNECT_FAILED,context:i}),t}}async runAgent({agent:n}){n.agentId&&this.core.suggestionEngine.clearSuggestions(n.agentId),n instanceof t.HttpAgent&&(n.headers={...this.core.headers});try{const e=await n.runAgent({forwardedProps:this.core.properties,tools:this.buildFrontendTools(n.agentId),context:Object.values(this.core.context)},this.createAgentErrorSubscriber(n));return this.processAgentResult({runAgentResult:e,agent:n})}catch(t){const r=t instanceof Error?t:new Error(String(t)),i={};throw n.agentId&&(i.agentId=n.agentId),await this.core.emitError({error:r,code:e.CopilotKitCoreErrorCode.AGENT_RUN_FAILED,context:i}),t}}async processAgentResult({runAgentResult:e,agent:t}){const{newMessages:n}=e,r=t.agentId;let i=!1;for(const e of n)if("assistant"===e.role)for(const s of e.toolCalls||[])if(-1===n.findIndex(e=>"tool"===e.role&&e.toolCallId===s.id)){const n=this.getTool({toolName:s.function.name,agentId:t.agentId});if(n){await this.executeSpecificTool(n,s,e,t,r)&&(i=!0)}else{const n=this.getTool({toolName:"*",agentId:t.agentId});if(n){await this.executeWildcardTool(n,s,e,t,r)&&(i=!0)}}}return i?await this.runAgent({agent:t}):(this.core.suggestionEngine.reloadSuggestions(r),e)}async executeSpecificTool(t,r,i,s,o){if((null==t?void 0:t.agentId)&&t.agentId!==s.agentId)return!1;let a,u="",d=!1;if(null==t?void 0:t.handler){let n;try{n=JSON.parse(r.function.arguments)}catch(t){const n=t instanceof Error?t:new Error(String(t));a=n.message,d=!0,await this.core.emitError({error:n,code:e.CopilotKitCoreErrorCode.TOOL_ARGUMENT_PARSE_FAILED,context:{agentId:o,toolCallId:r.id,toolName:r.function.name,rawArguments:r.function.arguments,toolType:"specific",messageId:i.id}})}if(await this.core.notifySubscribers(e=>{var t;return null===(t=e.onToolExecutionStart)||void 0===t?void 0:t.call(e,{copilotkit:this.core,toolCallId:r.id,agentId:o,toolName:r.function.name,args:n})},"Subscriber onToolExecutionStart error:"),!a)try{const e=await t.handler(n,r);u=null==e?"":"string"==typeof e?e:JSON.stringify(e)}catch(t){const s=t instanceof Error?t:new Error(String(t));a=s.message,await this.core.emitError({error:s,code:e.CopilotKitCoreErrorCode.TOOL_HANDLER_FAILED,context:{agentId:o,toolCallId:r.id,toolName:r.function.name,parsedArgs:n,toolType:"specific",messageId:i.id}})}if(a&&(u=`Error: ${a}`),await this.core.notifySubscribers(e=>{var t;return null===(t=e.onToolExecutionEnd)||void 0===t?void 0:t.call(e,{copilotkit:this.core,toolCallId:r.id,agentId:o,toolName:r.function.name,result:a?"":u,error:a})},"Subscriber onToolExecutionEnd error:"),d)throw new Error(null!=a?a:"Tool execution failed")}if(!a||!d){const e=s.messages.findIndex(e=>e.id===i.id),o={id:n.randomUUID(),role:"tool",toolCallId:r.id,content:u};if(s.messages.splice(e+1,0,o),!a&&!1!==(null==t?void 0:t.followUp))return!0}return!1}async executeWildcardTool(t,r,i,s,o){if((null==t?void 0:t.agentId)&&t.agentId!==s.agentId)return!1;let a,u="",d=!1;if(null==t?void 0:t.handler){let n;try{n=JSON.parse(r.function.arguments)}catch(t){const n=t instanceof Error?t:new Error(String(t));a=n.message,d=!0,await this.core.emitError({error:n,code:e.CopilotKitCoreErrorCode.TOOL_ARGUMENT_PARSE_FAILED,context:{agentId:o,toolCallId:r.id,toolName:r.function.name,rawArguments:r.function.arguments,toolType:"wildcard",messageId:i.id}})}const s={toolName:r.function.name,args:n};if(await this.core.notifySubscribers(e=>{var t;return null===(t=e.onToolExecutionStart)||void 0===t?void 0:t.call(e,{copilotkit:this.core,toolCallId:r.id,agentId:o,toolName:r.function.name,args:s})},"Subscriber onToolExecutionStart error:"),!a)try{const e=await t.handler(s,r);u=null==e?"":"string"==typeof e?e:JSON.stringify(e)}catch(t){const n=t instanceof Error?t:new Error(String(t));a=n.message,await this.core.emitError({error:n,code:e.CopilotKitCoreErrorCode.TOOL_HANDLER_FAILED,context:{agentId:o,toolCallId:r.id,toolName:r.function.name,parsedArgs:s,toolType:"wildcard",messageId:i.id}})}if(a&&(u=`Error: ${a}`),await this.core.notifySubscribers(e=>{var t;return null===(t=e.onToolExecutionEnd)||void 0===t?void 0:t.call(e,{copilotkit:this.core,toolCallId:r.id,agentId:o,toolName:r.function.name,result:a?"":u,error:a})},"Subscriber onToolExecutionEnd error:"),d)throw new Error(null!=a?a:"Tool execution failed")}if(!a||!d){const e=s.messages.findIndex(e=>e.id===i.id),o={id:n.randomUUID(),role:"tool",toolCallId:r.id,content:u};if(s.messages.splice(e+1,0,o),!a&&!1!==(null==t?void 0:t.followUp))return!0}return!1}buildFrontendTools(e){return this._tools.filter(t=>!t.agentId||t.agentId===e).map(e=>{var t;return{name:e.name,description:null!==(t=e.description)&&void 0!==t?t:"",parameters:W(e)}})}createAgentErrorSubscriber(t){const n=async(e,n,r={})=>{const i={...r};t.agentId&&(i.agentId=t.agentId),await this.core.emitError({error:e,code:n,context:i})};return{onRunFailed:async({error:t})=>{await n(t,e.CopilotKitCoreErrorCode.AGENT_RUN_FAILED_EVENT,{source:"onRunFailed"})},onRunErrorEvent:async({event:t})=>{var r,i,s;const o=(null==t?void 0:t.rawEvent)instanceof Error?t.rawEvent:(null===(r=null==t?void 0:t.rawEvent)||void 0===r?void 0:r.error)instanceof Error?t.rawEvent.error:void 0,a="string"==typeof(null===(i=null==t?void 0:t.rawEvent)||void 0===i?void 0:i.error)?t.rawEvent.error:null!==(s=null==t?void 0:t.message)&&void 0!==s?s:"Agent run error",u=null!=o?o:new Error(a);(null==t?void 0:t.code)&&!u.code&&(u.code=t.code),await n(u,e.CopilotKitCoreErrorCode.AGENT_RUN_ERROR_EVENT,{source:"onRunErrorEvent",event:t,runtimeErrorCode:null==t?void 0:t.code})}}}}const G={type:"object",properties:{}};function W(e){if(!e.parameters)return{...G};const t=((e,t)=>{const n=g(t);let r="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>({...e,[t]:B(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0)??y(n)}),{}):void 0;const i="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,s=B(e._def,void 0===i?n:{...n,currentPath:[...n.basePath,n.definitionPath,i]},!1)??y(n),o="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==o&&(s.title=o),n.flags.hasReferencedOpenAiAnyType&&(r||(r={}),r[n.openAiAnyTypeName]||(r[n.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===n.$refStrategy?"1":[...n.basePath,n.definitionPath,n.openAiAnyTypeName].join("/")}}));const a=void 0===i?r?{...s,[n.definitionPath]:r}:s:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,i].join("/"),[n.definitionPath]:{...r,[i]:s}};return"jsonSchema7"===n.target?a.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"!==n.target&&"openAi"!==n.target||(a.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===n.target&&("anyOf"in a||"oneOf"in a||"allOf"in a||"type"in a&&Array.isArray(a.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),a})(e.parameters,{$refStrategy:"none"});if(!t||"object"!=typeof t)return{...G};const{$schema:n,...r}=t;return"string"!=typeof r.type&&(r.type="object"),"object"==typeof r.properties&&null!==r.properties||(r.properties={}),Q(r),r}function Q(e){if(!e||"object"!=typeof e)return;if(Array.isArray(e))return void e.forEach(Q);const t=e;void 0!==t.additionalProperties&&delete t.additionalProperties;for(const e of Object.values(t))Q(e)}class X{constructor(e){this.core=e,this.stateByRun=new Map,this.messageToRun=new Map,this.agentSubscriptions=new Map}initialize(){}subscribeToAgent(e){if(!e.agentId)return;const t=e.agentId;this.unsubscribeFromAgent(t);const{unsubscribe:n}=e.subscribe({onRunStartedEvent:({event:t,state:n})=>{this.handleRunStarted(e,t,n)},onRunFinishedEvent:({event:t,state:n})=>{this.handleRunFinished(e,t,n)},onStateSnapshotEvent:({event:t,input:n,state:r})=>{this.handleStateSnapshot(e,t,n,r)},onStateDeltaEvent:({event:t,input:n,state:r})=>{this.handleStateDelta(e,t,n,r)},onMessagesSnapshotEvent:({event:t,input:n,messages:r})=>{this.handleMessagesSnapshot(e,t,n,r)},onNewMessage:({message:t,input:n})=>{this.handleNewMessage(e,t,n)}});this.agentSubscriptions.set(t,n)}unsubscribeFromAgent(e){const t=this.agentSubscriptions.get(e);t&&(t(),this.agentSubscriptions.delete(e))}getStateByRun(e,t,n){var r,i;const s=null===(i=null===(r=this.stateByRun.get(e))||void 0===r?void 0:r.get(t))||void 0===i?void 0:i.get(n);if(s)return JSON.parse(JSON.stringify(s))}getRunIdForMessage(e,t,n){var r,i;return null===(i=null===(r=this.messageToRun.get(e))||void 0===r?void 0:r.get(t))||void 0===i?void 0:i.get(n)}getStatesForThread(e,t){var n,r;return null!==(r=null===(n=this.stateByRun.get(e))||void 0===n?void 0:n.get(t))&&void 0!==r?r:new Map}getRunIdsForThread(e,t){var n;const r=null===(n=this.stateByRun.get(e))||void 0===n?void 0:n.get(t);return r?Array.from(r.keys()):[]}handleRunStarted(e,t,n){if(!e.agentId)return;const{threadId:r,runId:i}=t;this.saveState(e.agentId,r,i,n)}handleRunFinished(e,t,n){if(!e.agentId)return;const{threadId:r,runId:i}=t;this.saveState(e.agentId,r,i,n)}handleStateSnapshot(e,t,n,r){if(!e.agentId)return;const{threadId:i,runId:s}=n,o={...r,...t.snapshot};this.saveState(e.agentId,i,s,o)}handleStateDelta(e,t,n,r){if(!e.agentId)return;const{threadId:i,runId:s}=n;this.saveState(e.agentId,i,s,r)}handleMessagesSnapshot(e,t,n,r){if(!e.agentId)return;const{threadId:i,runId:s}=n;for(const n of t.messages)this.associateMessageWithRun(e.agentId,i,n.id,s)}handleNewMessage(e,t,n){if(!e.agentId||!n)return;const{threadId:r,runId:i}=n;this.associateMessageWithRun(e.agentId,r,t.id,i)}saveState(e,t,n,r){this.stateByRun.has(e)||this.stateByRun.set(e,new Map);const i=this.stateByRun.get(e);i.has(t)||i.set(t,new Map);i.get(t).set(n,JSON.parse(JSON.stringify(r)))}associateMessageWithRun(e,t,n,r){this.messageToRun.has(e)||this.messageToRun.set(e,new Map);const i=this.messageToRun.get(e);i.has(t)||i.set(t,new Map);i.get(t).set(n,r)}clearAgentState(e){this.stateByRun.delete(e),this.messageToRun.delete(e)}clearThreadState(e,t){var n,r;null===(n=this.stateByRun.get(e))||void 0===n||n.delete(t),null===(r=this.messageToRun.get(e))||void 0===r||r.delete(t)}}var Y,ee,te;e.CopilotKitCoreErrorCode=void 0,(Y=e.CopilotKitCoreErrorCode||(e.CopilotKitCoreErrorCode={})).RUNTIME_INFO_FETCH_FAILED="runtime_info_fetch_failed",Y.AGENT_CONNECT_FAILED="agent_connect_failed",Y.AGENT_RUN_FAILED="agent_run_failed",Y.AGENT_RUN_FAILED_EVENT="agent_run_failed_event",Y.AGENT_RUN_ERROR_EVENT="agent_run_error_event",Y.TOOL_ARGUMENT_PARSE_FAILED="tool_argument_parse_failed",Y.TOOL_HANDLER_FAILED="tool_handler_failed",Y.TRANSCRIPTION_FAILED="transcription_failed",Y.TRANSCRIPTION_SERVICE_NOT_CONFIGURED="transcription_service_not_configured",Y.TRANSCRIPTION_INVALID_AUDIO="transcription_invalid_audio",Y.TRANSCRIPTION_RATE_LIMITED="transcription_rate_limited",Y.TRANSCRIPTION_AUTH_FAILED="transcription_auth_failed",Y.TRANSCRIPTION_NETWORK_ERROR="transcription_network_error",e.CopilotKitCoreRuntimeConnectionStatus=void 0,(ee=e.CopilotKitCoreRuntimeConnectionStatus||(e.CopilotKitCoreRuntimeConnectionStatus={})).Disconnected="disconnected",ee.Connected="connected",ee.Connecting="connecting",ee.Error="error";e.ToolCallStatus=void 0,(te=e.ToolCallStatus||(e.ToolCallStatus={})).InProgress="inProgress",te.Executing="executing",te.Complete="complete",e.AgentRegistry=i,e.ContextStore=s,e.CopilotKitCore=class{constructor({runtimeUrl:e,runtimeTransport:t="rest",headers:n={},credentials:r,properties:a={},agents__unsafe_dev_only:u={},tools:d=[],suggestionsConfig:c=[]}){this.subscribers=new Set,this._headers=n,this._credentials=r,this._properties=a,this.agentRegistry=new i(this),this.contextStore=new s(this),this.suggestionEngine=new o(this),this.runHandler=new V(this),this.stateManager=new X(this),this.agentRegistry.initialize(u),this.runHandler.initialize(d),this.suggestionEngine.initialize(c),this.stateManager.initialize(),this.agentRegistry.setRuntimeTransport(t),this.agentRegistry.setRuntimeUrl(e),this.subscribe({onAgentsChanged:({agents:e})=>{Object.values(e).forEach(e=>{e.agentId&&this.stateManager.subscribeToAgent(e)})}})}async notifySubscribers(e,t){await Promise.all(Array.from(this.subscribers).map(async n=>{try{await e(n)}catch(e){console.error(t,e)}}))}async emitError({error:e,code:t,context:n={}}){await this.notifySubscribers(r=>{var i;return null===(i=r.onError)||void 0===i?void 0:i.call(r,{copilotkit:this,error:e,code:t,context:n})},"Subscriber onError error:")}get context(){return this.contextStore.context}get agents(){return this.agentRegistry.agents}get tools(){return this.runHandler.tools}get runtimeUrl(){return this.agentRegistry.runtimeUrl}setRuntimeUrl(e){this.agentRegistry.setRuntimeUrl(e)}get runtimeTransport(){return this.agentRegistry.runtimeTransport}setRuntimeTransport(e){this.agentRegistry.setRuntimeTransport(e)}get runtimeVersion(){return this.agentRegistry.runtimeVersion}get headers(){return this._headers}get credentials(){return this._credentials}get properties(){return this._properties}get runtimeConnectionStatus(){return this.agentRegistry.runtimeConnectionStatus}get audioFileTranscriptionEnabled(){return this.agentRegistry.audioFileTranscriptionEnabled}setHeaders(e){this._headers=e,this.agentRegistry.applyHeadersToAgents(this.agentRegistry.agents),this.notifySubscribers(e=>{var t;return null===(t=e.onHeadersChanged)||void 0===t?void 0:t.call(e,{copilotkit:this,headers:this.headers})},"Subscriber onHeadersChanged error:")}setCredentials(e){this._credentials=e,this.agentRegistry.applyCredentialsToAgents(this.agentRegistry.agents)}setProperties(e){this._properties=e,this.notifySubscribers(e=>{var t;return null===(t=e.onPropertiesChanged)||void 0===t?void 0:t.call(e,{copilotkit:this,properties:this.properties})},"Subscriber onPropertiesChanged error:")}setAgents__unsafe_dev_only(e){this.agentRegistry.setAgents__unsafe_dev_only(e)}addAgent__unsafe_dev_only(e){this.agentRegistry.addAgent__unsafe_dev_only(e)}removeAgent__unsafe_dev_only(e){this.agentRegistry.removeAgent__unsafe_dev_only(e)}getAgent(e){return this.agentRegistry.getAgent(e)}addContext(e){return this.contextStore.addContext(e)}removeContext(e){this.contextStore.removeContext(e)}addSuggestionsConfig(e){return this.suggestionEngine.addSuggestionsConfig(e)}removeSuggestionsConfig(e){this.suggestionEngine.removeSuggestionsConfig(e)}reloadSuggestions(e){this.suggestionEngine.reloadSuggestions(e)}clearSuggestions(e){this.suggestionEngine.clearSuggestions(e)}getSuggestions(e){return this.suggestionEngine.getSuggestions(e)}addTool(e){this.runHandler.addTool(e)}removeTool(e,t){this.runHandler.removeTool(e,t)}getTool(e){return this.runHandler.getTool(e)}setTools(e){this.runHandler.setTools(e)}subscribe(e){return this.subscribers.add(e),{unsubscribe:()=>{this.subscribers.delete(e)}}}async connectAgent(e){return this.runHandler.connectAgent(e)}stopAgent(e){e.agent.abortRun()}async runAgent(e){return this.runHandler.runAgent(e)}getStateByRun(e,t,n){return this.stateManager.getStateByRun(e,t,n)}getRunIdForMessage(e,t,n){return this.stateManager.getRunIdForMessage(e,t,n)}getRunIdsForThread(e,t){return this.stateManager.getRunIdsForThread(e,t)}buildFrontendTools(e){return this.runHandler.buildFrontendTools(e)}},e.ProxiedCopilotRuntimeAgent=r,e.RunHandler=V,e.StateManager=X,e.SuggestionEngine=o,e.completePartialMarkdown=function(e){let t=e;const n=Array.from(t.matchAll(/^(\s*)(`{3,}|~{3,})/gm));if(n.length%2==1){const[,e,r]=n[0];t+=`\n${e}${r}`}t.match(/\[([^\]]*)\]\(([^)]*)$/)&&(t+=")");const r=[],i=Array.from(t),s=[],o=[];let a=0,u=-1;for(let e=0;e<i.length;e++)if(0===e||"\n"===i[e-1]){const n=t.substring(e).match(/^(\s*)(`{3,}|~{3,})/);n&&(a++,a%2==1?u=e:-1!==u&&(s.push({start:u,end:e+n[0].length}),u=-1),e+=n[0].length-1)}for(let e=0;e<i.length;e++)if("`"===i[e]){let t=0;for(let n=e-1;n>=0&&"\\"===i[n];n--)t++;if(t%2==0)for(let t=e+1;t<i.length;t++)if("`"===i[t]){let n=0;for(let e=t-1;e>=0&&"\\"===i[e];e--)n++;if(n%2==0){o.push({start:e,end:t+1}),e=t;break}}}const d=e=>s.some(t=>e>=t.start&&e<t.end)||o.some(t=>e>=t.start&&e<t.end);for(let e=0;e<i.length;e++){const t=i[e],n=i[e+1],s=i[e-1];if(!d(e))if("["===t){let t=!1,n=1,s=e+1;for(;s<i.length&&n>0;)"["!==i[s]||d(s)||n++,"]"!==i[s]||d(s)||n--,s++;if(0===n&&"("===i[s]){let n=1;for(s++;s<i.length&&n>0;)"("!==i[s]||d(s)||n++,")"!==i[s]||d(s)||n--,s++;if(0===n){t=!0,e=s-1;continue}}if(!t){const t=r.findIndex(e=>"bracket"===e.type);-1!==t?r.splice(t,1):r.push({type:"bracket",marker:"[",position:e})}}else if("*"===t&&"*"===n){const t=r.findIndex(e=>"bold_star"===e.type);-1!==t?r.splice(t,1):r.push({type:"bold_star",marker:"**",position:e}),e++}else if("_"===t&&"_"===n){const t=r.findIndex(e=>"bold_underscore"===e.type);-1!==t?r.splice(t,1):r.push({type:"bold_underscore",marker:"__",position:e}),e++}else if("~"===t&&"~"===n){const t=r.findIndex(e=>"strike"===e.type);-1!==t?r.splice(t,1):r.push({type:"strike",marker:"~~",position:e}),e++}else if("*"===t&&"*"!==s&&"*"!==n){const t=r.findIndex(e=>"italic_star"===e.type);-1!==t?r.splice(t,1):r.push({type:"italic_star",marker:"*",position:e})}else if("_"===t&&"_"!==s&&"_"!==n){const t=r.findIndex(e=>"italic_underscore"===e.type);-1!==t?r.splice(t,1):r.push({type:"italic_underscore",marker:"_",position:e})}}let c=0;for(let e=0;e<i.length;e++)"`"!==i[e]||d(e)||c++;c%2==1&&(t+="`"),r.sort((e,t)=>t.position-e.position);let l=t+r.map(e=>{switch(e.type){case"bracket":return"]";case"bold_star":return"**";case"bold_underscore":return"__";case"strike":return"~~";case"italic_star":return"*";case"italic_underscore":return"_";default:return""}}).join("");const g=Array.from(l.matchAll(/^(\s*)(`{3,}|~{3,})/gm)),h=(l.match(/`/g)||[]).length%2==1,f=g.length%2==1;let p=!h&&!f;if(p){const e=l.lastIndexOf("(");if(-1!==e){(l.substring(0,e).match(/`/g)||[]).length%2==1&&(p=!1)}}if(p){const e=(l.match(/\(/g)||[]).length,t=(l.match(/\)/g)||[]).length;e>t&&(l+=")".repeat(e-t))}return l}});
//# sourceMappingURL=index.umd.js.map
