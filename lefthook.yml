# Lefthook configuration - migrated from husky
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: false
  commands:
    check-root-md-files:
      run: |
        ALLOWED_ROOT_MD="README.md|CHANGELOG.md|CONTRIBUTING.md|LICENSE.md|CLAUDE.md|AGENTS.md"
        root_md_files=$(git diff --cached --name-only --diff-filter=A | grep -E '^[^/]+\.md$' | grep -vE "^($ALLOWED_ROOT_MD)$" || true)
        if [ -n "$root_md_files" ]; then
          echo "ERROR: Attempting to add .md files in root directory:"
          echo "$root_md_files"
          echo ""
          echo "âŒ æ ¹ç›®å½•ç¦æ­¢åˆ›å»ºæ–°çš„ .md æ–‡æ¡£ã€‚è¯·å°†æ–‡æ¡£æ”¾å…¥ docs/ ç›®å½•ä¸­ã€‚"
          echo ""
          echo "å…è®¸çš„ä¾‹å¤–æ–‡ä»¶:"
          echo "  - README.md, CHANGELOG.md, CONTRIBUTING.md"
          echo "  - LICENSE.md, CLAUDE.md, AGENTS.md"
          echo ""
          echo "<system-reminder>"
          echo "â†’ Next: git reset HEAD <file> â†’ mv to docs/{specifications,architecture,guides,runbooks} â†’ git add"
          echo "</system-reminder>"
          exit 1
        fi
      stage_fixed: false

    check-forbidden-docs:
      run: |
        FORBIDDEN_PATTERNS="STATUS|REPORT|SUMMARY|PROGRESS|IMPLEMENTATION|_LOG|_NOTES|QUICKREF|QUICK|_V[0-9]|_OLD|_NEW"
        process_docs=$(git diff --cached --name-only --diff-filter=A | grep -E '\.md$' | grep -vE '^docs/runbooks/' | grep -iE "($FORBIDDEN_PATTERNS)" || true)
        if [ -n "$process_docs" ]; then
          echo "ERROR: Attempting to add process/status documents:"
          echo "$process_docs"
          echo ""
          echo "âŒ ç¦æ­¢æäº¤ä»¥ä¸‹ç±»å‹çš„æ–‡æ¡£:"
          echo "  - çŠ¶æ€æŠ¥å‘Š: *_STATUS.md, *_REPORT.md, *REPORT*.md"
          echo "  - è¿›åº¦æ–‡æ¡£: *_PROGRESS.md, *_IMPLEMENTATION.md"
          echo "  - è¿‡ç¨‹è®°å½•: *_LOG.md, *_NOTES.md"
          echo "  - ä¸´æ—¶æ‘˜è¦: *_SUMMARY.md, *_QUICKREF.md, *_QUICK.md"
          echo "  - å†—ä½™å˜ä½“: *_V1.md, *_V2.md, *_OLD.md, *_NEW.md"
          echo ""
          echo "ä¾‹å¤–: docs/runbooks/ å…è®¸å®¡è®¡å’ŒéªŒè¯æŠ¥å‘Š"
          echo ""
          echo "<system-reminder>"
          echo "â†’ Next: git reset HEAD <file> â†’ grep -r '<concept>' docs/ to find canonical source â†’ consolidate"
          echo "</system-reminder>"
          exit 1
        fi
      stage_fixed: false

    check-root-forbidden-files:
      run: |
        # æ£€æŸ¥ä¸´æ—¶æµ‹è¯•è„šæœ¬
        forbidden_scripts=$(git diff --cached --name-only --diff-filter=A | grep -E '^(test_.*\.sh|.*\.test\.sh)$' || true)

        # æ£€æŸ¥ç¦æ­¢çš„æµ‹è¯•æ•°æ®ç›®å½•
        forbidden_dirs=$(git diff --cached --name-only --diff-filter=A | grep -E '^(profiles|migrations|fixtures|test-data)/' || true)

        if [ -n "$forbidden_scripts" ] || [ -n "$forbidden_dirs" ]; then
          echo "ERROR: Detected forbidden files/directories in root:"
          [ -n "$forbidden_scripts" ] && echo "$forbidden_scripts"
          [ -n "$forbidden_dirs" ] && echo "$forbidden_dirs"
          echo ""
          echo "âŒ æ ¹ç›®å½•ç¦æ­¢åˆ›å»º:"
          echo "  - ä¸´æ—¶æµ‹è¯•è„šæœ¬: test_*.sh, *.test.sh"
          echo "  - æµ‹è¯•æ•°æ®ç›®å½•: profiles/, migrations/, fixtures/, test-data/"
          echo ""
          echo "âœ… æ­£ç¡®ä½ç½®:"
          echo "  - æµ‹è¯•è„šæœ¬ â†’ scripts/ æˆ–ä½¿ç”¨ pnpm test"
          echo "  - Migrations â†’ rust-services/crates/*/migrations/ æˆ– packages/storage/prisma/migrations/"
          echo "  - Fixtures â†’ tests/fixtures/ æˆ– __fixtures__/"
          echo ""
          echo "<system-reminder>"
          echo "â†’ Next:"
          if [ -n "$forbidden_scripts" ]; then
            echo "  git reset HEAD <script> â†’ Remove ad-hoc scripts or mv to scripts/ â†’ git add"
          fi
          if [ -n "$forbidden_dirs" ]; then
            echo "  Replace static fixtures with Factory Pattern/Fixture Builders for dynamic generation"
          fi
          echo "</system-reminder>"
          exit 1
        fi
      stage_fixed: false

    check-doc-content:
      glob: "docs/**/*.md"
      run: |
        # æ£€æŸ¥è¢«ä¿®æ”¹çš„æ–‡æ¡£ï¼ˆæ’é™¤ runbooksï¼‰
        modified_docs=$(git diff --cached --name-only --diff-filter=AM | grep -E '^docs/.*\.md$' | grep -vE '^docs/runbooks/' || true)

        if [ -z "$modified_docs" ]; then
          exit 0
        fi

        # é¡¹ç›®ç®¡ç†æœ¯è¯­ï¼ˆä¸­è‹±æ–‡ï¼‰
        FORBIDDEN_TERMS="(Author:|Owner:|Assignee:|Maintainer:|Contributor:|ä½œè€…:|è´Ÿè´£äºº:|ç»´æŠ¤è€…:)"
        FORBIDDEN_TERMS="${FORBIDDEN_TERMS}|(é¢„è®¡[0-9]+[å‘¨å¤©å°æ—¶äººæ—¥])|(est\.|estimated|[Ee]stimat(e|ion))"
        FORBIDDEN_TERMS="${FORBIDDEN_TERMS}|(Week [0-9]+:|Phase [0-9]+:|Stage [0-9]+:|Step [0-9]+-[0-9]+:)"
        FORBIDDEN_TERMS="${FORBIDDEN_TERMS}|(ç¬¬[ä¸€äºŒä¸‰å››äº”1-9][å‘¨å¤©é˜¶æ®µ])|(é˜¶æ®µ[1-9]:)|(æ­¥éª¤[0-9]+-[0-9]+:)"
        FORBIDDEN_TERMS="${FORBIDDEN_TERMS}|(Q[1-4] 20[0-9]{2}|Deadline:|Milestone|é‡Œç¨‹ç¢‘)"
        FORBIDDEN_TERMS="${FORBIDDEN_TERMS}|(å¾…å¼€å§‹|æœªå¼€å§‹|è¿›è¡Œä¸­ [0-9]+%|é˜»å¡ä¸­)"
        FORBIDDEN_TERMS="${FORBIDDEN_TERMS}|([Ii]n [Pp]rogress|[Bb]locked|[Nn]ot [Ss]tarted)"
        FORBIDDEN_TERMS="${FORBIDDEN_TERMS}|(åˆ†å·¥:|è´£ä»»åˆ†é…:|å›¢é˜Ÿåˆ†é…:|Sprint [0-9]+)"
        FORBIDDEN_TERMS="${FORBIDDEN_TERMS}|(å·¥ä½œé‡:)"

        violations=""
        for file in $modified_docs; do
          matches=$(git diff --cached "$file" | grep "^+" | grep -v "^+++" | grep -E "$FORBIDDEN_TERMS" || true)
          if [ -n "$matches" ]; then
            violations="${violations}\n${file}:\n${matches}\n"
          fi
        done

        if [ -n "$violations" ]; then
          echo "ERROR: æ–‡æ¡£ä¸­æ£€æµ‹åˆ°ç¦æ­¢çš„é¡¹ç›®ç®¡ç†æœ¯è¯­:"
          printf '%b' "$violations"
          echo ""
          echo "âŒ æŠ€æœ¯æ–‡æ¡£ä¸­ä¸åº”å‡ºç°:"
          echo "  - ä½œè€…/è´Ÿè´£äºº: Author, Owner, Assignee, Maintainer, è´Ÿè´£äºº, ç»´æŠ¤è€…"
          echo "  - å·¥ä½œé‡ä¼°ç®—: é¢„è®¡Xå‘¨/å¤©/å°æ—¶, est., estimated, å·¥ä½œé‡"
          echo "  - å®æ–½è®¡åˆ’: Week 1:, Phase 1:, Step 1-3, ç¬¬ä¸€å‘¨, é˜¶æ®µ1, æ­¥éª¤1-3"
          echo "  - æœªæ¥æ—¶é—´çº¿: Q1 2025, Deadline, Milestone, é‡Œç¨‹ç¢‘"
          echo "  - é¡¹ç›®çŠ¶æ€: å¾…å¼€å§‹, è¿›è¡Œä¸­ 60%, In Progress, Blocked"
          echo "  - åä½œä¿¡æ¯: åˆ†å·¥, è´£ä»»åˆ†é…, å›¢é˜Ÿåˆ†é…, Sprint"
          echo ""
          echo "âœ… å…è®¸çš„çŠ¶æ€æè¿°:"
          echo "  - å®ŒæˆçŠ¶æ€: completed, fixed, implemented, å·²å®Œæˆ, å·²å®æ–½"
          echo "  - å®Œæˆæ—¶é—´: completed on 2026-01-06, å®æ–½äº2026-01-06"
          echo ""
          echo "<system-reminder>"
          echo "â†’ Next: Strip ephemeral metadata (timelines/assignments/progress) â†’ Focus on invariants â†’ git add"
          echo "</system-reminder>"
          exit 1
        fi
      stage_fixed: false

    check-secrets:
      run: |
        # æ£€æŸ¥å¸¸è§çš„ç¡¬ç¼–ç å¯†é’¥æ¨¡å¼
        sensitive=$(git diff --cached --diff-filter=AM | grep "^+" | grep -v "^+++" | grep -iE "(api[_-]?key|password|secret[_-]?key|access[_-]?token).*(=|:).*(sk-|pk-|['\"][A-Za-z0-9]{32,}['\"])" || true)

        if [ -n "$sensitive" ]; then
          echo ""
          echo "âš ï¸  WARNING: å¯èƒ½æ£€æµ‹åˆ°ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯:"
          echo "$sensitive"
          echo ""
          echo "è¯·ç¡®è®¤ä»¥ä¸Šå†…å®¹ä¸åŒ…å«çœŸå®çš„ API keys/passwords/tokens"
          echo ""
          echo "<system-reminder>"
          echo "â†’ Next: git reset HEAD <file> â†’ Move secrets to env vars/vault â†’ Update .env.example â†’ git add"
          echo "   (For docs only: LEFTHOOK_EXCLUDE=check-secrets git commit)"
          echo "</system-reminder>"
          echo ""
        fi
      stage_fixed: false

    check-license-text:
      run: |
        # æ£€æŸ¥é LICENSE æ–‡ä»¶ä¸­çš„å®Œæ•´ LICENSE æè¿°æ–‡æœ¬
        # æ’é™¤ LICENSEã€LICENSE.mdã€COPYING ç­‰ä¸“é—¨çš„ license æ–‡ä»¶
        modified_files=$(git diff --cached --name-only --diff-filter=AM | grep -vE '^(LICENSE|LICENSE\.md|COPYING|COPYING\.md)$' || true)

        if [ -z "$modified_files" ]; then
          exit 0
        fi

        # LICENSE æ–‡æœ¬çš„å¸¸è§ç‰¹å¾æ¨¡å¼
        LICENSE_PATTERNS="(Permission is hereby granted, free of charge)|(WITHOUT WARRANTY OF ANY KIND)|(THIS SOFTWARE IS PROVIDED)|(Subject to the terms and conditions)|(Apache License, Version 2\.0)|(GNU (GENERAL|LESSER) PUBLIC LICENSE)|(BSD [0-9]-Clause License)"

        violations=""
        for file in $modified_files; do
          # æ£€æŸ¥æ–°å¢çš„è¡Œï¼ˆ+ å¼€å¤´ï¼‰æ˜¯å¦åŒ…å« LICENSE æ–‡æœ¬
          matches=$(git diff --cached "$file" | grep "^+" | grep -v "^+++" | grep -iE "$LICENSE_PATTERNS" || true)
          if [ -n "$matches" ]; then
            violations="${violations}\n${file}:\n${matches}\n"
          fi
        done

        if [ -n "$violations" ]; then
          echo "ERROR: æ£€æµ‹åˆ°å®Œæ•´çš„ LICENSE æè¿°æ–‡æœ¬:"
          printf '%b' "$violations"
          echo ""
          echo "âŒ ä»£ç å’Œæ–‡æ¡£æ–‡ä»¶ä¸­ä¸åº”åŒ…å«:"
          echo "  - å®Œæ•´çš„ LICENSE æ–‡æœ¬ï¼ˆMITã€Apacheã€BSDã€GPL ç­‰ï¼‰"
          echo "  - LICENSE å…è´£å£°æ˜å…¨æ–‡"
          echo "  - è¯¦ç»†çš„è®¸å¯æ¡æ¬¾å’Œæ¡ä»¶"
          echo ""
          echo "âœ… å…è®¸çš„ LICENSE å¼•ç”¨æ–¹å¼:"
          echo "  - SPDX æ ‡è¯†ç¬¦: // SPDX-License-Identifier: MIT"
          echo "  - ç®€çŸ­å¼•ç”¨: // Licensed under the MIT License"
          echo "  - é¡¹ç›®æ ¹ç›®å½•çš„ LICENSE æˆ– LICENSE.md æ–‡ä»¶"
          echo ""
          echo "<system-reminder>"
          echo "â†’ Next: git reset HEAD <file> â†’ Replace with // SPDX-License-Identifier: MIT â†’ git add"
          echo "</system-reminder>"
          exit 1
        fi
      stage_fixed: false

    check-code-quality:
      run: |
        # æ£€æŸ¥ä»£ç æ–‡ä»¶ä¸­çš„å ä½ç¬¦ã€TODOã€è°ƒè¯•ä»£ç 
        code_files=$(git diff --cached --name-only --diff-filter=AM | grep -E '\.(ts|tsx|js|jsx|mjs|cjs|py|go|rs|java|c|cpp|h|hpp)$' || true)

        if [ -z "$code_files" ]; then
          exit 0
        fi

        violations=""

        for file in $code_files; do
          # æ£€æŸ¥å ä½ç¬¦ä»£ç 
          placeholder_matches=$(git diff --cached "$file" | grep "^+" | grep -v "^+++" | grep -iE '(TODO|FIXME|XXX|HACK|placeholder|dummy.*implementation|temp.*implementation)' || true)
          if [ -n "$placeholder_matches" ]; then
            violations="${violations}\nã€å ä½ç¬¦ä»£ç ã€‘${file}:\n${placeholder_matches}\n"
          fi

          # æ£€æŸ¥è°ƒè¯•ä»£ç ï¼ˆå…è®¸åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ä½¿ç”¨ï¼‰
          if ! echo "$file" | grep -qE '\.(test|spec)\.(ts|tsx|js|jsx|py|go|rs)$'; then
            debug_matches=$(git diff --cached "$file" | grep "^+" | grep -v "^+++" | grep -E '(console\.(log|debug|info|warn)|debugger;|print\(|println!|fmt\.Println|System\.out\.println)' || true)
            if [ -n "$debug_matches" ]; then
              violations="${violations}\nã€è°ƒè¯•ä»£ç ã€‘${file}:\n${debug_matches}\n"
            fi
          fi
        done

        if [ -n "$violations" ]; then
          echo "âš ï¸  WARNING: æ£€æµ‹åˆ°éœ€è¦æ³¨æ„çš„ä»£ç è´¨é‡é—®é¢˜:"
          printf '%b' "$violations"
          echo ""
          echo "âŒ ç”Ÿäº§ä»£ç ä¸­ä¸åº”åŒ…å«:"
          echo "  - å ä½ç¬¦: TODO, FIXME, XXX, HACK, placeholder"
          echo "  - è°ƒè¯•ä»£ç : console.log, debugger, print, println"
          echo "  - ä¸´æ—¶å®ç°: dummy implementation, temp implementation"
          echo ""
          echo "<system-reminder>"
          echo "â†’ Next: Complete implementation â†’ Migrate TODOs to issue tracker â†’ Remove debug code â†’ git add"
          echo "   (For test utils/dev tools: LEFTHOOK_EXCLUDE=check-code-quality git commit)"
          echo "</system-reminder>"
          echo ""
          # è¿™æ˜¯è­¦å‘Šï¼Œä¸é˜»æ­¢æäº¤ï¼ˆå¯æ ¹æ®éœ€è¦æ”¹ä¸º exit 1ï¼‰
        fi
      stage_fixed: false

    lint-staged:
      glob: "**/*.{cjs,mjs,js,ts,tsx,json,md,mdx}"
      run: |
        if [ "${CI:-}" = "true" ]; then
          pnpm exec dprint fmt {staged_files}
        else
          echo "lint-staged skipped (CI only)"
        fi
      stage_fixed: true

commit-msg:
  commands:
    validate-message:
      run: |
        MSG_FILE="{1}"
        if [ ! -f "$MSG_FILE" ]; then
          echo "ERROR: commit message file not found: $MSG_FILE"
          exit 1
        fi

        first_line="$(sed -n '1p' "$MSG_FILE" | tr -d '\r')"
        line_count="$(wc -l < "$MSG_FILE" | tr -d ' ')"
        second_line="$(sed -n '2p' "$MSG_FILE" | tr -d '\r')"

        if [ "$line_count" -gt 4 ]; then
          echo "ERROR: commit message has too many lines (max 4)." 
          echo ""
          echo "<system-reminder>â†’ Next: simplify commit messages. "
          echo "Use single-line commit messages by default. Add a multi-line "
          echo "description only when necessary to provide essential context, reasoning, or impact"
          echo "</system-reminder>"
          exit 1
        fi

        if [ "$line_count" -gt 1 ] && [ -n "$second_line" ]; then
          echo "ERROR: commit body must be separated by a blank line."
          exit 1
        fi

        if [ "${#first_line}" -gt 100 ]; then
          echo "ERROR: commit subject exceeds 100 characters."
          exit 1
        fi

        if ! printf '%s\n' "$first_line" | grep -Eq '^[^[:space:]]+ [a-z]+\([a-z0-9-]+\): .+'; then
          echo "ERROR: commit subject must match '<emoji> <type>(<scope>): <subject>'."
          echo "Example: âœ¨ feat(auth): add OAuth2 login"
          exit 1
        fi

        if grep -iq "Co-Authored-By:" "$MSG_FILE"; then
          echo "ERROR: commit message contains 'Co-Authored-By:' which is not allowed."
          exit 1
        fi

        if grep -iE "(Generated (with|by))|(ğŸ¤–.*Generated)" "$MSG_FILE" >/dev/null 2>&1; then
          echo "ERROR: commit message contains AI generation markers which are not allowed."
          echo ""
          echo "âŒ ç¦æ­¢çš„ç”Ÿæˆæ ‡è®°:"
          echo "  - Generated with [Claude Code]"
          echo "  - Generated by ..."
          echo "  - ğŸ¤– Generated ..."
          echo ""
          exit 1
        fi

        # Check for prohibited project management terms (CLAUDE.md compliance)
        PROHIBITED_PATTERNS="(Phases? [0-9])|(Stages? [0-9])|(Steps? [0-9])|(Week [0-9])|(Day [0-9])|([Ii]n [Pp]rogress)|([0-9]+% done)|(Sprint [0-9])|(Milestone)|(est\.)|(estimated)|(é¢„è®¡)|(è®¡åˆ’)|(è´Ÿè´£äºº)|(å·¥ä½œé‡)|(Owner)|(Assignee)"
        if grep -E "$PROHIBITED_PATTERNS" "$MSG_FILE" >/dev/null 2>&1; then
          echo "ERROR: commit message contains prohibited project management terms."
          echo ""
          echo "âŒ æäº¤æ—¥å¿—ä¸­ç¦æ­¢å‡ºç°ä»¥ä¸‹å†…å®¹:"
          echo "  - è®¡åˆ’æ€§æ—¶é—´: Day 1, Week 2, Phase 1, Stage 1/2, Step 1/2"
          echo "  - è¿›åº¦æ ‡è®°: In Progress, 50% done, è¿›è¡Œä¸­"
          echo "  - é¡¹ç›®ç®¡ç†: Sprint 1, Milestone, è´Ÿè´£äºº, Owner, Assignee"
          echo "  - å·¥ä½œé‡ä¼°ç®—: est., estimated, é¢„è®¡Xå°æ—¶/å¤©/å‘¨"
          echo ""
          echo "âœ… å…è®¸çš„çŠ¶æ€æè¿°:"
          echo "  - completed, fixed, implemented, resolved"
          echo "  - completed on 2026-01-06, å®æ–½äº..."
          echo ""
          exit 1
        fi

        # Extract commit type and provide type-specific suggestions
        commit_type=$(printf '%s\n' "$first_line" | sed -E 's/^[^[:space:]]+ ([a-z]+)\([a-z0-9-]+\):.*/\1/')

        if [ -n "$commit_type" ]; then
          echo ""
          echo "<system-reminder>"
          echo "ğŸ“‹ Type-Specific Quality Gate (type: $commit_type):"
          echo ""

          case "$commit_type" in
            refactor)
              echo "  â™»ï¸ Recommended Actions:"
              echo "  â†’ Verify: Obsolete code removed; no dead imports/commented blocks"
              echo "  â†’ Check: DRY + Single Responsibility; <50 lines/func; â‰¤3 nesting"
              echo "  â†’ Run: All tests; confirm behavioral equivalence"
              echo "  â†’ Document: Create ADR if 2+ modules or pattern/perf/security impact"
              ;;
            feat)
              echo "  âœ¨ Recommended Actions:"
              echo "  â†’ Validate: Simple Design (tests pass, clear intent, DRY, minimal elements)"
              echo "  â†’ Review: Considered simpler approaches? Checked OSS solutions? Justified build vs buy?"
              echo "  â†’ Complete: Remove TODO/debug; run tests; update docs"
              echo "  â†’ Document: Create ADR if 2+ modules, new infra/patterns, or tech selection"
              ;;
            fix)
              echo "  ğŸ› Recommended Actions:"
              echo "  â†’ Complete: Remove placeholders/debug; avoid new duplication"
              echo "  â†’ Test: Add regression test; link issue; run all tests"
              echo "  â†’ Document: Update CHANGELOG if user-facing"
              ;;
            docs)
              echo "  ğŸ“ â†’ Verify: Links valid; examples executable; no PM terms"
              ;;
            test)
              echo "  âœ… â†’ Check: All pass; coverage improved; AAA pattern; isolated"
              ;;
            chore)
              echo "  ğŸ”§ â†’ Verify: Code unaffected; build/CI validated"
              ;;
            perf)
              echo "  âš¡ â†’ Action: Add benchmarks; preserve correctness; document gains"
              ;;
            style)
              echo "  ğŸ’„ â†’ Verify: Linter run; no logic change; tests pass"
              ;;
            build)
              echo "  ğŸ—ï¸ â†’ Check: Local build OK; deps compatible; licenses OK"
              ;;
            ci)
              echo "  ğŸ‘· â†’ Verify: Syntax valid; secrets configured; tested in PR"
              ;;
            revert)
              echo "  âª â†’ Action: Explain rationale; update issue; notify stakeholders"
              ;;
            *)
              echo "  ğŸ’¡ â†’ Verify: Meets standards; tests pass; docs updated"
              ;;
          esac

          echo "</system-reminder>"
          echo ""
        fi

pre-push:
  commands:
    validate:
      run: pnpm run validate

post-rewrite:
  commands:
    validate-rebase-commits:
      run: |
        rewrite_type="{1}"
        if [ "$rewrite_type" != "rebase" ]; then
          exit 0
        fi

        # Lefthook doesn't pass stdin like native git hooks.
        # Use timeout to read stdin, falling back to checking recent commits.
        invalid_commits=""
        PROHIBITED_PATTERNS="(Phases? [0-9])|(Stages? [0-9])|(Steps? [0-9])|(Week [0-9])|(Day [0-9])|([Ii]n [Pp]rogress)|([0-9]+% done)|(Sprint [0-9])|(Milestone)|(est\.)|(estimated)|(é¢„è®¡)|(è®¡åˆ’)|(è´Ÿè´£äºº)|(å·¥ä½œé‡)|(Owner)|(Assignee)"

        if read -t 1 -r old_sha new_sha rest 2>/dev/null; then
          # stdin available, process it
          while true; do
            msg=$(git log -1 --format=%s "$new_sha" 2>/dev/null || echo "")
            if [ -n "$msg" ]; then
              if ! printf '%s\n' "$msg" | grep -Eq '^[^[:space:]]+ [a-z]+\([a-z0-9-]+\): .+'; then
                invalid_commits="${invalid_commits}  ${new_sha}: ${msg}\n"
              fi
              full_msg=$(git log -1 --format=%B "$new_sha" 2>/dev/null || echo "")
              if printf '%s\n' "$full_msg" | grep -iq "Co-Authored-By:"; then
                invalid_commits="${invalid_commits}  ${new_sha}: contains Co-Authored-By\n"
              fi
              if printf '%s\n' "$full_msg" | grep -iE "(Generated (with|by))|(ğŸ¤–.*Generated)" >/dev/null 2>&1; then
                invalid_commits="${invalid_commits}  ${new_sha}: contains AI generation markers\n"
              fi
              if printf '%s\n' "$full_msg" | grep -E "$PROHIBITED_PATTERNS" >/dev/null 2>&1; then
                invalid_commits="${invalid_commits}  ${new_sha}: contains prohibited project management terms\n"
              fi
              line_count=$(printf '%s\n' "$full_msg" | wc -l | tr -d ' ')
              if [ "$line_count" -gt 4 ]; then
                invalid_commits="${invalid_commits}  ${new_sha}: too many lines (${line_count} > 4)\n"
              fi
            fi
            read -t 1 -r old_sha new_sha rest 2>/dev/null || break
          done
        fi

        if [ -n "$invalid_commits" ]; then
          echo ""
          echo "ERROR: The following rebased commits have invalid commit messages:"
          printf '%b' "$invalid_commits"
          echo ""
          echo "Expected format: <emoji> <type>(<scope>): <subject>"
          echo "Example: âœ¨ feat(auth): add OAuth2 login"
          echo ""
          echo "âŒ Prohibited in commit messages:"
          echo "  - Project management terms: Phase 1, Week 2, In Progress, Sprint, Milestone"
          echo "  - Too many lines (max 4 lines including blank line)"
          echo "  - Co-Authored-By or Generated by"
          echo ""
          echo "<system-reminder>"
          echo "â†’ Next: git rebase -i HEAD~N â†’ Mark commits as 'reword'/'edit' â†’ Fix each message"
          echo "</system-reminder>"
          echo ""
          exit 1
        fi
